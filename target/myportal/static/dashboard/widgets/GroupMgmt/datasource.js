b$.module("bd",function(){var a=b$.require("b$.Class");var d=b$.require("b$.mvc.Model");var h=b$.require("b$.mvc.Observable");function c(o,p,r,q){return be.utils.ajax({type:r,url:o,contentType:"text/xml",cache:false,data:p,processData:false,dataType:"xml",success:q})}var n=this.Dashboard=a.extend(function(o){o=o||{};this.clientSideXSL=true});var j=new n();var m=this.DataSource=h.extend(function(o){h.call(this);o=o||{};this._loadedPages={};this._allLoaded=false;this._xslCallbackQueue=[];this._totalSize=0;this._currentSize=0;this._html=null;this._xml=null;this._clientSidePaging=o.clientSidePaging||false;this._preRenderAll=o.preRenderAll||false;this._useXSL=o.xslURL!=undefined;this.setPageSize(o.pageSize||5);this.setURL(o.restURL||"");this.setOffset(o.offset||0);this.setFilter(o.filterField||"",o.filterValue||"",o.filterOperator||"");this.setSorting(o.sortingField||"",o.sortingOrder||"");this.setViewport(o.viewport);if(j.clientSideXSL&&this._useXSL){this.loadXSL(o.xslURL)}this.setXSLParams(o.xslParams);if(o.restURL){this.requestPage()}});m.prototype.setViewport=function(o){this._viewport=o||document.createDocumentFragment()};m.prototype.setURL=function(o){this._URL=o};m.prototype.setPageSize=function(o){this._pageSize=o;this.setOffset()};m.prototype.setPage=function(o){this.setOffset(o*this._pageSize)};m.prototype.setOffset=function(p){this._lastPage=this._page||0;this._lastOffset=this._offset||0;if(p!=undefined){this._offset=p}else{this._offset=this._offset||0}this._page=this.getCurrentPageNumber();var o=this._pageSize;var q=this._offset;if(this._clientSidePaging){q=0;o=1000}this._paging=["of=",q,"&ps=",o].join("")};m.prototype.setFilter=function(o,q,p){if(o&&q){this.filter=["f=",o,"(",p||"eq",")",q].join("")}else{this.filter=""}};m.prototype.setSorting=function(o,p){if(o&&p){this.sorting=["s=",o,"(",p||"asc",")"].join("")}else{this.sorting=""}};m.prototype.getLastOffset=function(){return this._lastOffset};m.prototype.getOffset=function(){return this._offset};m.prototype.getLastPage=function(){return this._lastPage};m.prototype.getPage=function(){return this._page};m.prototype.getHTML=function(){return this._html};m.prototype.getXML=function(){return this._xml};m.prototype.getJSON=function(){return this._json};m.prototype.getCurrentRecordCount=function(){return this._currentSize};m.prototype.getTotalRecordCount=function(){return this._totalSize};m.prototype.getRemainingRecordCount=function(){if(!this._totalSize){return 1}var o=(this._totalSize-(this._offset+this._pageSize));return o>0?o:0};m.prototype.getTotalPageCount=function(){if(!this._totalSize){return this._page+2}return Math.ceil(this._totalSize/this._pageSize)};m.prototype.getCurrentPageNumber=function(){return this._offset/this._pageSize};m.prototype.setXSLParams=function(o){this._XSLParameters=o||{}};m.prototype.loadXSL=function(o){var q=this;var p=function(r){q._XSL=r;for(var s=q._xslCallbackQueue.length;s>0;s--){var u=q._xslCallbackQueue.pop();try{u.apply(q)}catch(t){console.log(u);console.dir(t)}}};$.get(o,null,p,"xml")};m.prototype.waitForXSL=function(o){if(!j.clientSideXSL||this._XSL||!this._useXSL){o()}else{this._xslCallbackQueue.push(o)}};m.prototype.buildRequestURL=function(){var o=this._URL+"?"+this._paging;if(this.filter){o+="&"+this.filter}if(this.sorting){o+="&"+this.sorting}return o};m.prototype.render=function(o){this._viewport.innerHTML=o};m.prototype.requestPreviousPage=function(o){if(this._page>0){this.setPage(this._page-1);this.requestPage(o)}};m.prototype.requestNextPage=function(o){if(this._page<this.getTotalPageCount()-1){this.setPage(this._page+1);this.requestPage(o)}};m.prototype.refreshPage=function(o){if(this._clientSidePaging){this._aXMLPages=null}this._allLoaded=false;if(o){var p=this._offset;var q=this._pageSize;this.setPageSize((p*q)||q)}else{this._loadedPages={}}this.setOffset(0);this.requestPage();if(o){this._offset=p;this._pageSize=q}};m.prototype.bufferXMLpages=function(o){this._aXMLPages=[];var s=o.lastChild;var w=s.childNodes.length;s.setAttribute("totalSize",w);var r=s.childNodes;var x=w/this._pageSize;for(var q=0;q<=x;q++){var t=q*this._pageSize;var y=t+this._pageSize;var v="<"+s.nodeName+' totalSize="'+w+'">';for(var u=t;u<y&&u<w;u++){v+=b(r[u])}v+="</"+s.nodeName+">";this._aXMLPages.push($.parseXML(v))}};m.prototype.requestPage=function(o){var t=this;var s=this.buildRequestURL();if(o&&this._loadedPages[this._page]||this._allLoaded){t.notifyObservers("pagechange");return}this._loadedPages[this._page]=true;if(this._preRenderAll){this._allLoaded=true}var q=function(y,x){var v="";var w=t._pageSize;if(y){var u=y.lastChild;if(u){t._totalSize=parseInt(u.getAttribute("totalSize")||0);w=u.childNodes.length;t.notifyObservers("pagechange")}t._xml=y;t._json=f(y);if(t._useXSL){t._html=i(y,t._XSL,t._XSLParameters)}else{t._html=y.documentElement.textContent}}if(x!="success"){t._html=x}if(t._viewport){if(!o){t._currentSize=w;t._viewport.innerHTML=t._html}else{t._currentSize+=w;t._viewport.innerHTML+=t._html}}t.notifyObservers("change")};var r;if(this._clientSidePaging){if(this._aXMLPages){r=function(){q(t._aXMLPages[t._page],"success")}}else{var p=function(u){if(u){t.bufferXMLpages(u);if(t._preRenderAll){q(u,"success")}else{q(t._aXMLPages[t._page],"success")}}};r=function(){t.sendRequest(s,null,"get",p,function(u){q(null,u)})}}}else{r=function(){t.sendRequest(s,null,"get",q,function(u){q(null,u)})}}this.waitForXSL(r)};m.prototype.sendRequest=function(s,r,p,o,t){var q=bd.contextRoot+"/"+s;if(r){r=k(r)}c(q,r,p,o)};m.prototype.submitForm=function(s,o,r){var q=s.getAttribute("action");var t=s.getAttribute("method").toLowerCase();var p=g(s);this.sendRequest(q,p,t,o,r)};m.prototype.requestDelete=function(p,o,q){this.sendRequest(p,null,"delete",o,q)};var g=function(q){var p=e(q);var o=l(p);return o};var e=function(u){var w={};var o=function(B,D){var A=w;var z=$.merge(jQuery(B),jQuery(B).parents("[name]"));for(var y=z.length-1;y>=0;y--){var C=z[y].getAttributeNode("name").value;if(C!=""){if(!A[C]){var x={};if(y==0){x=D}A[C]={"xns:attributes":z[y].getAttribute("xns:attributes")||"","xns:value":x}}A=A[C]["xns:value"]}}return A};var t=jQuery("[name]",u);for(var r=0,p=t.length;r<p;r++){var s=t[r];if(jQuery(s).has("[name]").length==0){var v;switch(s.getAttribute("type")){case"checkbox":v=s.checked;break;default:v=s.value||"";v=be.utils.formatAllowedName(v)}var q=o(s,v)}}return w};var k=function(o){return'<?xml version="1.0" encoding="UTF-8" standalone="yes"?>'+o};var l=function(r){var q="";if(typeof r=="object"){if(r.constructor===Array){for(var o=0;o<r.length;o++){q+=l(r[o])}}else{for(var p in r){if(p!="xns:value"&&p!="xns:attributes"){q+="<"+p+" "+r[p]["xns:attributes"]+">";q+=l(r[p]["xns:value"]);q+="</"+p+">"}}}}else{q+=be.utils.xmlEscape(r+"")}return q};var f=function(q){var u={};if(q.nodeType==1){if(q.attributes.length>0){u["@attributes"]={};for(var p=0;p<q.attributes.length;p++){var t=q.attributes.item(p);u["@attributes"][t.nodeName]=t.nodeValue}}}else{if(q.nodeType==3){u=q.nodeValue}}if(q.hasChildNodes()){for(var r=0;r<q.childNodes.length;r++){var s=q.childNodes.item(r);var v=s.nodeName;if(typeof(u[v])=="undefined"){u[v]=f(s)}else{if(typeof(u[v].length)=="undefined"){var o=u[v];u[v]=[];u[v].push(o)}u[v].push(f(s))}}}return u};var i=function(s,v,o){try{var u=new XSLTProcessor();u.importStylesheet(v);for(var q in o){var p=(typeof o[q]==="function"?o[q]():o[q]);if(p!==undefined){u.setParameter("",q,p)}}var r;if(b$.browser.ie){result=u.transformToFragment(s,document);bd.fragPlaceHolde=bd.fragPlaceHolde||document.createElement("div");bd.fragPlaceHolde.appendChild(result);result=bd.fragPlaceHolde.innerHTML;bd.fragPlaceHolde.innerHTML="";return result}else{result=u.transformToDocument(s);return(new XMLSerializer()).serializeToString(result)||result.xml}}catch(t){console.dir(t);throw (t)}};var b=function(o){if(o.xml){return o.xml}else{return new XMLSerializer().serializeToString(o)}}});