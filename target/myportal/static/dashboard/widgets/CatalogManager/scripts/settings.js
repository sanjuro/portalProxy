define(["backbase.com.2014.components/scripts/filePicker","backbase.com.2014.components/scripts/formDataManager","./utils","./dnd"],function(k,p,m,o){var i="Unsupported file type. Please use JPG, JPEG, PNG, SVG or GIF files only.";var f=["jpg","jpeg","png","gif","svg"];var t="{{0}} has been created successfully";var j="{{0}} has been updated successfully";var r="Resource upload failed";var d="Please, select file you want to upload";var n="Resource uploading in progress";var h=bd.contextRoot+"/bb-admin-api";var q=h+"/itemresource";var v={};var l;var g;function u(x){var w;switch(x){case"contenttype":w="Content Type";break;case"page":w="Master Page";break;case"container":w="Layout";break;default:w=x;break}return w}function c(){window.clearTimeout(g);if(l&&l.length){l.click()}l=null}function s(){g=window.setTimeout(function(){l=$(m.notify(n,"loading",{delay:-1}).$template[0])},2000)}var a;var b=function(w){return new k.FilePicker({dropZone:w.dropZone||".bd-fileupload-area",inputName:w.inputName||"file",inputLabelClass:"bd-input-trigger-label",immediateUpload:false,uploadUrl:w.uploadUrl,openCallback:w.openCallback,responseCallback:w.responseCallback})};var e=function(O,T,E,M,Q,z,A,P){var D=function(){M.removeClass("bd-import-active")};var x=function(){v={};D();o.set()};var w=function(U){};var L=function(U){D()};O=String(O);var N=Q.filter(function(U){return U.name===O})[0]||{isWidget:true,isNewWidget:true,thumbnailUrl:bd.contextRoot+"/static/dashboard/media/icons/icons-widgets_01-default.png"};N.thumbnailUrl=N.thumbnailUrl?N.thumbnailUrl.trim():"";N.tagsList=N.tags?N.tags.filter(function(U){return U.type==="regular"}).map(function(U){return U.name}).join(", "):"";N.sectionTagsList=N.tags?N.tags.filter(function(U){return U.type==="section"}).map(function(U){return U.name}).join(", "):"";N.thumbnailUploadAPI=q;var J=m.getHtmlTemplate("itemSettingsEdit.html",N);var y=function(ac){var aa=function(ad){if(ad){return{value:ad}}else{return null}};var W=be.utils.getTemplateDataFromForm(ac),Y,Z;delete W.bbCSRF;if(N.isNewWidget){Z=W;Z.name=new Date().getTime();Z.tags=Z.tags.split(",").map(aa);if(Z.tags.length>0&&Z.tags[0]!==null){Z.hasTags=true}}else{Z={name:O,type:T,properties:[]};for(var ab in W){if(W.hasOwnProperty(ab)){if(ab==="tags"){Z.tags=bd.getTagsDeltaModel(ac[0].tags);if(Z.tags.length>0&&Z.tags[0]!==null&&Z.tags[0].value){Z.hasTags=true}}else{if(ab==="sectionTags"){Z.sectionTags=bd.getTagsDeltaModel(ac[0].sectionTags);for(var X=0,V=Z.sectionTags.length;X<V;X++){Z.sectionTags[X].value=Z.sectionTags[X].value.toLowerCase()}if(Z.sectionTags.length>0&&Z.sectionTags[0]!==null&&Z.sectionTags[0].value){Z.hasTags=true}}else{Z.properties.push({name:ab,value:W[ab].replace(/^\s+|\s+$/g,""),type:ac.find('input[name="'+ab+'"]').data("type")||"string",viewHint:ac.find('input[name="'+ab+'"]').data("viewhint")||"",manageable:ac.find('input[name="'+ab+'"]').data("manageable")||"true"})}}}}}if(N.isNewWidget){Y=m.getXmlTemplate("serverCatalogItem.xml",Z)}else{Y=m.getXmlTemplate("portalCatalogItem.xml",{items:[Z],updateAction:true,isCatalogOperation:N.notInPortalCatalog})}var U=h+"/catalog.xml";if(E&&!N.isCatalogOperation){if(N.isNewWidget){U=h+"/portals/"+bd.selectedPortalName+"/catalog.xml"}else{U=h+"/portals/"+bd.selectedPortalName+"/"+N.type+"s/"+N.name}}be.utils.ajax({url:U,data:Y,type:N.isNewWidget?"POST":"PUT",encodeURI:false,success:function(){m.notify(m.applyTxtTpl(N.isNewWidget?t:j,[u(N.type)]),"checkbox");A(z,null,null,O);P()}});x()};var H=N.title?N.title:O;var I=new p.FormDataManager({url:q,allowMultipleFiles:false});function B(V){var W=$("#thumbnailUrl",V);var U=$('form[target="uploadHelperIFrame"]');if(!v.files){y(V);return}if(!U.length&&I.isEmpty()){m.notify(d,"error");return}else{s();if(U.length){U.find("iframe").one("load",function(){y(V);A(z)});U[0].submit()}else{I.sendForm(function(X){c();if(X){W.val(X)}y(V)},function(){c();m.notify(r,"error")})}x()}}var K=bc.component.modalform({width:"450px",title:O?T+" settings: "+H:"New widget",uid:"04001",cls:"bd-catalog-item-settings-form",content:J,ok:"Save",cancel:"Cancel",okCallback:function(U){B(U)},cancelCallback:function(){x()}});function F(V){var U=window.FileReader?new FileReader():undefined;if(U&&V){U.onload=function(W){$(".bd-catalog-settings-icon-preview",K).attr("src",W.target.result)};U.readAsDataURL(V)}}function G(V){var U=this.options.allowedFileTypes;if(V.dataTransfer.files[0].name.match(new RegExp("\\.(?:"+U+")$","i"))){v=V.dataTransfer;I.addItems(v);F(v.files[v.files.length-1]);D();a.removeDetachedForm()}else{m.notify(i);D()}}o.set({canvas:"body",dropZone:".bd-fileupload-area",allowedFileTypes:f.join("|"),overCallback:w,dropCallback:G,leaveWindowCallback:L,allowMultipleFiles:false}).options.$dropZone.addClass("bd-added-file");if(a){a.destroy()}a=b({dropZone:".bd-fileupload-area",uploadUrl:q,expectedResponse:/[a-zA-Z\/]/,openCallback:function(W){var V=this.$detachedForm.find('input[type="file"]')[0],U=V?V.files:undefined,X=U[0]?U[0].name||"":"";if(!X.match(new RegExp("\\.(?:"+f.join("|")+")$","i"))){m.notify(i);this.removeDetachedForm();return false}v={files:[{name:X}]};F(U[0]);I.reset()},responseCallback:function(U){var V=$(U).text();c();if(V.match(/[a-zA-Z\/]/)){A(z);$("#thumbnailUrl",K).val(V)}else{m.notify(r,"error")}}});var R=$(".bc-tab-labels .bc-tab-label",K);R.click(function(U){var V=$(this);$(".bc-tab-content",K).hide();$(".bc-tab-content"+V.data("for"),K).show()});if(!E){bc.component.radioButton({target:".bd-catalog-widget-backbase",color:"white",uid:"04028",name:"bd-catalog-widget-type",value:"backbase",label:"Backbase",checked:true,handler:function(){$(".bd-catalog-settings-src",K).attr("name","src");$(".bd-catalog-settings-icon-preview",K).attr("src",bd.contextRoot+"/static/dashboard/media/icons/icons-widgets_01-default.png");$(".bd-catalog-settings-icon-value",K).val(bd.contextRoot+"/static/dashboard/media/icons/icons-widgets_01-default.png");$(".bd-catalog-settings-template",K).val("Standard_Widget")}});bc.component.radioButton({target:".bd-catalog-widget-w3c",color:"white",uid:"04029",name:"bd-catalog-widget-type",value:"w3c",label:"W3C",handler:function(){$(".bd-catalog-settings-src",K).attr("name","defaultStartFile");$(".bd-catalog-settings-icon-preview",K).attr("src",bd.contextRoot+"/static/backbase.com.2012.aurora/media/icons/icons-pmwidgets_w3c.png");$(".bd-catalog-settings-icon-value",K).val(bd.contextRoot+"/static/backbase.com.2012.aurora/media/icons/icons-pmwidgets_w3c.png");$(".bd-catalog-settings-template",K).val("W3C_Widget")}})}var S=$(".bd-catalog-settings-icon",K),C=$(".bd-catalog-settings-icon-edit",K);setTimeout(function(){if($("#itemTags",K).length>0){bd.initTags($("#itemTags",K))}if($("#sectionTags",K).length>0){bd.initTags($("#sectionTags",K))}},100);C.on("click",".bd-catalog-settings-icon-save",function(U){U.preventDefault();var V=$('input[type="text"]',C).val().replace(/^\s+|\s+$/,"");$("img",S).attr("src",be.utils.replaceParams(V,bd.oPortalClient.params)+"?_="+Math.random());S.show();C.hide()});C.on("click",".bd-catalog-settings-icon-cancel",function(U){U.preventDefault();$('input[type="text"]',C).val($("img",S).attr("src"));S.show();C.hide()})};return{show:e}});