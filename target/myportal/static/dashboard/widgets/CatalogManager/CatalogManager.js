define(["dashboard/widgets/PortalMgmt/scripts/portal-export","backbase.com.2014.components/scripts/filePicker","backbase.com.2014.components/scripts/formDataManager","zenith/utils","zenith/http/portals","./scripts/dnd","./scripts/utils","./scripts/settings"],function(h,a,f,d,e,c,g,b){bd.portal=b$.portal||{};bd.portal.config=bd.portal.config||{serverRoot:bd.contextRoot};bd.portal.portalName=bd.portal.portalName||bd.portalName;bd.oPortalClient=bd.oPortalClient||{};bd.oPortalClient.params={contextRoot:bd.portal.config.serverRoot,portalType:"dashboard"};bd.CatalogManager=(function(aK){var ar=30,a4=false,u=0,au,aY={};var v=bd.contextRoot+"/catalog.xml";var aW=bd.contextRoot+"/catalog/delete";var aA=bd.contextRoot+"/import/package";var H=bd.contextRoot+"/tags/catalog?ps=-1";var i,aV,a3;var aQ="All Items",aL="Widgets",q="Master pages",az="Layouts",E="Content types",m="Templates",S="Features",aR="Title",Q="Type",o="Creation Date",aN="All on this page",l="None",aT={enterprise:function(a5){if(a5>1){return"REMOVE "+a5+" ITEMS FROM ENTERPRISE CATALOG?"}return"REMOVE ITEM FROM ENTERPRISE CATALOG?"},portal:function(a5){if(a5>1){return"REMOVE "+a5+" ITEMS FROM "+g.shrink(bd.selectedPortalName,7).toUpperCase()+" PORTAL CATALOG?"}return"REMOVE ITEM FROM "+g.shrink(bd.selectedPortalName,7).toUpperCase()+" PORTAL CATALOG?"}},aZ={enterprise:"This action cannot be undone.<br/>Are you sure you want to continue?",portal:"This will also remove all instances from the portal pages.<br/>This cannot be undone."},k="REMOVE",G="CANCEL",A="Items were successfully removed",a2="Something went wrong",aS="Item import",ac="Unsupported file type",t="Please, select file you want to import",aX="Import in progress",aj="Item was successfully imported",at="Import failed",aC="OK",C="CANCEL",av=["zip"],aM='The {{0}} "{{1}}" was successfully duplicated';var j=false;var T=false;var aI,ag,a0;var am=[];var aO,ae=be.utils.cookie(bd.portal.portalName+"_sortDir")||"dsc";var Y={};var ao=[];var aU={container:az,page:q,template:m,contenttype:E,widget:aL,all:aQ,feature:S};var n={server:["container","page","template","contenttype","widget","feature"],portal:["container","page","contenttype","widget"]};var an,aJ;var V,aP,J,ab=aK("");var aE,L=false,aa;var al=function(){V.removeClass("bd-import-active")};var ax=function(){au.css({marginTop:V.hasClass("bd-catalog-tags-active")?J[0].offsetHeight:"auto"})};var aw=function(){var a5=j?i:H;if(aI.value){a5+="&f=type(eq)"+aI.value.toUpperCase()}be.utils.ajax({url:a5,dataType:"xml",cache:false,encodeURI:false,success:function(a7){var a6={tags:[]};var a8=aK(a7);a8.find("> tags > tag").each(function(ba,bf){var bb=aK(bf);a6.tags.push({tag:bb.text(),type:bb.attr("type")})});a6.tags.sort(function(bb,ba){if(bb.tag>ba.tag){return 1}if(bb.tag<ba.tag){return -1}return 0});var a9=g.getHtmlTemplate("tag.html",a6);J.html(a9);ax()},error:function(){console.log("ERROR - unable load tags")}})};var B=function(a7,a6){var a5=am.indexOf(a7);if(a5!==-1){am.splice(a5,1)}if(a6!==null){a7.value=String(a6);am.push(a7)}else{a7.value=a6}if(!a0.value){aw()}};var ah=function(a5){return ao.filter(function(a6){return a6.name===a5})[0]};var X=function(a6){var a5=a6.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&");return new RegExp("("+a5+")","i")};var aq=function(){aK(".bd-catalog-item",V).each(function(a5,a9){var a6=aK(a9),ba=String(a6.data("name")),a8=ah(ba),a7;if(ag.value){a7=X(ag.value)}if(!a8||!ba.match(a7)&&!(a8.title&&a8.title.match(a7))||!ag.value){if(a6.data("originalTitle")!==undefined){a6.find(".bc-tile-title").text(Mustache.to_html("{{text}}",{text:a6.data("originalTitle")}))}}else{a6.data("originalTitle",a8.title);a6.find(".bc-tile-title").html(Mustache.to_html("{{text}}",{text:a8.title||a8.name}).replace(a7,'<span class="bd-catalog-search-highlight">$1</span>'))}})};var aB=function(){if(aP){aP.hide()}};var W=function(){if(aP){aP.appendTo(au).show()}else{var a5='<div class="bd-catalog-loading-icon"><div class="bd-catalog-item-thumbnail" style="height:100%;background: transparent url('+bd.contextRoot+'/static/backbase.com.2012.components/media/loading_icon_32.png) no-repeat center"s></div></div>';aP=aK(a5);au=au||aK(".bd-catalog-main",V);au.append(aP)}};var ai=function(bf,bb,a9,a8){if(a4){return}if(bb){T=false}var a5,a7=aK(".bd-catalog-item:visible",V).length,ba="",a6=be.utils.cookie(bd.portal.portalName+"_sortField")||"createdTimestamp";W();if(aI.value){ba="&f=type(eq)"+aI.value.toUpperCase()}a5=(j?aV:v)+"?ps="+ar+ba+"&s="+a6+"("+ae+")";if(ag.value){a5+="&f=property.title(like)"+encodeURIComponent(ag.value)}if(a0.value){a5+="&f=tag.name(eq)"+a0.value}if(!a4&&T){if(a7%ar===0&&!aI.value){u=ar;a5+="&of="+u}else{u=a7;a5+="&of="+u}}a4=true;be.utils.ajax({url:a5,dataType:"xml",cache:false,encodeURI:false,success:function(bk){if(!T){ao=[];aY={}}var bi=[],bl=aK(bk),bj=j?n.portal:n.server,bh=bj.map(function(bm){return">catalog>"+bm}).join(",");bl.find(bh).each(function(){var bm=g.parseItem(this,j,a8);aK(bm.tags).each(function(bo,bn){if(bn.name.toLowerCase()==="cxpmanager"){bm.hasCXPTag=true}if(bn.name.toLowerCase()==="hide-in-catalog"||bn.name.toLowerCase()==="hideincatalog"){bm.hasHiddenTag=true}});bi.push(bm);aY[bm.uuid]={title:bm.title,type:bm.type,name:bm.name}});ao=ao.concat(bi);var bg=false;if(bf){bg=bf(bi,a9)}if(!bg){T=false;aB();aq();a4=false}},error:function(){T=false;aB();a4=false}})};var ak=function(){aK(".bd-catalog-item",V).removeClass("bc-s-selected bc-s-first");aK(".bc-s-active, .bc-s-multi",V).removeClass("bc-s-active bc-s-multi")};var D=function(a6,a7){var a5;if(a6&&a6.length!==undefined){var a9=g.getHtmlTemplate("itemList.html",{items:a6});if(T){var a8=aK(a9);a8.each(function(ba,bb){a5=aK(bb);if(a5.hasClass("bd-catalog-item")){var bf=a5.data("name");if(aK('.bd-catalog-item[data-name="'+bf+'"]',V).length===0){au.append(a5)}}})}else{au.html(a9);ak()}if(a7){a5=au.find(".bd-catalog-item[data-name="+a7+"]");if(!a5.length){a4=false;T=true;ai(D,false,a7);return true}else{a5.addClass("bc-s-selected");a5[0].scrollIntoView();return false}}}};var y=function(a5,a6){return b.show(a5,a6,j,V,ao,D,ai,aw)};var ad;var w=function(a5){return new a.FilePicker({dropZone:a5.dropZone||".bd-fileupload-area",inputName:a5.inputName||"file",inputLabelClass:"bd-input-trigger-label",immediateUpload:false,uploadUrl:a5.uploadUrl,openCallback:a5.openCallback,responseCallback:a5.responseCallback})};var F=function(a6){var a5=this.options.allowedFileTypes;Y=a6.dataTransfer;if(!Y.files||!Y.files.length){g.notify(t,"error");al();return false}else{if(!Y.files[0].name.match(new RegExp("\\.(?:"+a5+")$","i"))){g.notify(ac);al();return false}}aa.addItems(Y);if(!L){x()}else{ad.removeDetachedForm()}al();aK(".bd-fileupload-area",this.options.dropZone).addClass("bd-added-file").find(".bd-has-file .bd-file-text").text(Y.files[Y.files.length-1].name)};var p=function(){V.removeClass("bd-catalog-tags-active");if(!L){V.addClass("bd-import-active")}};var M=function(a5){p()};var a1=function(a5){al()};var aH={canvas:"body",dropZone:".bd-catalog-import-drop",allowedFileTypes:av.join("|"),overCallback:M,dropCallback:F,leaveWindowCallback:a1,allowMultipleFiles:false};c.set(aH);var aG=function(){clearTimeout(aJ);aJ=setTimeout(function(){var a6=au[0],a9=a6.scrollHeight,a8=a6.scrollTop,a5=a6.clientHeight,a7=aK(".bd-catalog-item",V).height();if(a9-a8-a5<a7*1.5){T=true;ai(D)}},1000)};var s=function(a5){aK(".bd-catalog-item",V).each(function(bb,bg){var ba=aK(bg),bj=String(ba.data("name")),a8=String(ba.data("type")),bh=ah(bj),a9=false,bi,a7=null;var bf=function(bk){return bk.name===a7.value};for(var a6=0;a6<am.length;a6++){a7=am[a6];switch(a7.type){case"type":a9=a9||!bh||a8!==a7.value;break;case"title":bi=bi||X(a7.value);a9=a9||!bh||!bj.match(bi)&&!(bh.title&&bh.title.match(bi));break;case"tag":a9=a9||!bh||bh.tags.filter(bf).length===0;break;default:break}}a9?ba.hide():ba.css({display:""})});if(am.length!==0){aq();if(!a5){aG()}else{u=0;T=true;ai(D)}}else{ai(D,true);aw()}};var af=function(){V.toggleClass("bd-catalog-tags-active").removeClass("bd-import-active");ax();if(!V.hasClass("bd-catalog-tags-active")){B(a0,null);s()}};var aD=function(){var a5=aK(".bc-s-selected",V);aK(".bd-catalog-selection-count",V).text(a5.length);if(a5.length>1){aK(".bd-catalog-inline-confirm",V).remove()}};var aF=function(a5){aK(".bd-catalog-item",V).removeClass("bc-s-selected");switch(a5){case"all":aK(".bd-catalog-item:visible",V).addClass("bc-s-selected").parent().addClass("bc-s-active");break;case"none":aK(".bd-catalog-item",V).removeClass("bc-s-selected").parent().removeClass("bc-s-active");break;default:break}bc.component.checkSelectedItems(V,aK(".bc-s-wrapper",V));aD()};var N=function(){var a5=[];aK(".bc-s-selected",V).each(function(a6,a7){a5.push(String(aK(a7).data("name")))});return a5};var O=function(a9){var a7=a9.itemName;if(typeof a7==="string"){var a6=aK('.bd-catalog-item[data-name="'+a7+'"]',V);var a8=g.getHtmlTemplate("confirm.html",a9);var a5=a6.append(a8).find(".bd-catalog-inline-confirm");a5.on("click",function(ba){ba.stopPropagation()});a5.on("click","> .buttons > .ok",function(){a5.off().remove();if(a9.okCallback){a9.okCallback()}});a5.on("click","> .buttons > .cancel",function(){a5.off().remove();if(a9.cancelCallback){a9.cancelCallback()}})}else{be.utils.confirm({title:a9.title,message:a9.text,okBtnText:a9.okLabel,cancelBtnText:a9.cancelLabel,yesCallback:function(){if(a9.okCallback){a9.okCallback()}},noCallback:function(){if(a9.cancelCallback){a9.cancelCallback()}}})}};var U=function(a5,a6){O({itemName:a5,title:aT[j?"portal":"enterprise"](a5 instanceof Array?a5.length:1),text:aZ[j?"portal":"enterprise"],okLabel:k,cancelLabel:G,okCallback:function(){function bg(bj){return function(){if(typeof bj==="object"){bc.component.notify(bj)}ai(D,true);if(a6){a6(a5)}}}var bi=[];var a9=[];var bf=bg({uid:"04018",icon:"checkbox",message:A});var ba=function(bj,bk){if(!bk){bk=bj&&bj.errorMessage||a2}bg({uid:"04019",icon:"error",message:bk})()};if(typeof a5==="string"){a5=[a5]}for(var a8=0,a7=a5.length;a8<a7;a8++){var bh=aK('.bd-catalog-item[data-name="'+a5[a8]+'"]').data("type");if(bh==="page"){a9.push(a5[a8])}else{bi.push({name:a5[a8],type:bh})}}if(bi.length){var bb=g.getXmlTemplate("portalCatalogItem.xml",{items:bi,deleteAction:true,isCatalogOperation:true});be.utils.ajax({url:j?a3:aW,type:"POST",data:bb,encodeURI:false,success:bf,error:ba})}else{if(a9.length){d.forEach(a9,function(bj){be.promise.deleteMasterPage(bj,j?bd.selectedPortalName:undefined).then(d.throttle(bf,200),ba)})}}}})};var I=function(a6,a7,a5){h.exportItem(a6,a7,a5,j?bd.selectedPortalName:undefined)};var r=function(a6){var a5=aY[a6];be.promise.duplicateItem(a5.name,a5.type).done(function(a7){g.notify(g.applyTxtTpl(aM,[a5.type,a5.title]),"checkbox");var a8=a7[a5.type].name;ai(D,true,a8)})};var ap=function(){Y={};al();c.set();L=false};var x=function(){L=true;var a5=Y&&Y.files&&Y.files[Y.files.length-1];e.get({ps:"-1"}).then(function(a7){var a9=g.getHtmlTemplate("importDialog.html",{fileName:a5?a5.name:"",portals:a7,isIE:aK.browser.msie,isPortalCatalog:j}),a8=function(bi){var bf=aK(bi),bg=bf.find("level"),bb=bf.find("message"),bh=bb.text(),ba;ab.click();if(bg.length>0&&bb.length>0){switch(bg.text().toUpperCase()){case"INFO":if(bh.toUpperCase()==="SUCCESS"){g.notify(aj,"checkbox");ai(D)}break;case"ERROR":ba=(bh&&bh.length>70)?{delay:5000}:{};g.notify(bh,"error",ba);break}return}g.notify(at,"error")},a6=bc.component.modalform({uid:"04012",width:"450px",title:aS,cls:"bd-catalog-import-dialog",content:a9,ok:aC,cancel:C,okCallback:function(bb){var ba=aK('form[target="uploadHelperIFrame"]');var bf=[];if(!j){if(aK('.bd-catalog-import-toggle-portals input[type="checkbox"]',bb)[0].checked){aK('.bd-catalog-import-dialog .bd-catalog-import-toggle-portal input[type="checkbox"]',bb).each(function(bg,bh){var bi;if(bh.checked){bi=aK(bh).parents(".bd-catalog-import-toggle-portal").data("portal");ba.append('<input type="hidden" name="p" value="'+bi+'">');bf.push({name:"p",value:bi})}})}}if(!ba.length&&aa.isEmpty()){g.notify(t,"error");return false}else{ab=aK(g.notify(aX,"loading",{delay:-1}).$template[0]);if(ba.length){aK('<input type="hidden" name="bbCSRF" />').val(be.utils.getCookie("bbCSRF")).appendTo(ba);ba[0].submit()}else{bf.push({name:"bbCSRF",value:be.utils.getCookie("bbCSRF")});aa.addItems(bf);aa.sendForm(a8,function(){ab.click();g.notify(at,"error")})}ap()}},cancelCallback:function(){ap()}});c.set({canvas:"body",dropZone:".bd-fileupload-area",allowedFileTypes:av.join("|"),overCallback:M,dropCallback:F,leaveWindowCallback:a1,allowMultipleFiles:false});if(ad){ad.destroy()}ad=w({dropZone:".bd-fileupload-area",uploadUrl:aE,inputName:"package",openCallback:function(bb){var bf=bb.target.value,ba=this.options.$dropZone;if(!bf.match(new RegExp("\\.(?:"+av.join("|")+")$","i"))){g.notify(ac);this.removeDetachedForm();return false}ba.addClass("bd-added-file");bf=bf.split(/(?:\\|\/)/);bf=bf[bf.length-1];aK(".bd-has-file .bd-file-text",ba).text(bf);aa.reset()},responseCallback:a8});bc.component.toggleSwitch({target:aK(".bd-catalog-import-toggle-portals",a6),uid:"04014",checked:j,callback:function(bb,bf){var ba=aK(".bd-catalog-portals-list",a6);if(bf[0].checked){ba.show();if(!ba.data("initiated")){aK(".bd-catalog-import-toggle-portal",ba).each(function(bg,bi){var bh=bi.getAttribute("data-portal")==="dashboard";bc.component.toggleSwitch({target:aK(bi),uid:"04015",checked:!bh,name:aK(bi).data("portal"),callback:function(bk,bj){}})});ba.data("initiated",true)}}else{ba.hide()}}})})};var K=function(a6){var a5=aK(a6.target),a7=a5.hasClass("bd-catalog-item")?a5:a5.parents(".bd-catalog-item");if(a5.hasClass("bd-catalog-item-toolbar")||a5.parents(".bd-catalog-item-toolbar").length>0){a6.stopPropagation();ak();var a8=a5.parent().attr("class").replace(/^.*bd-catalog-item-([^\s]+).*$/,"$1");switch(a8){case"settings":y(String(a7.data("name")),a7.data("type"));break;case"remove":U(String(a7.data("name")));break;case"duplicate":r(a7.data("id"));break;case"export":I(String(a7.data("name")),a7.data("type"),!ah(String(a7.data("name"))).isExportable);break;default:break}}else{if(a5.hasClass("bd-catalog-item")||a5.parents(".bd-catalog-item").length>0){al()}}setTimeout(function(){aD()},1)};var ay=function(a5,a6){be.utils.ajax({url:aV+"?f=extendedItemName(eq)"+encodeURIComponent(a5),dataType:"xml",cache:false,encodeURI:false,success:function(a7){var a8=aK(a7),a9=a8.find("catalog>");if(a6){a6(a9.length>0)}}})};var Z=function(a5){ay(a5.extendedItemName,function(a8){var a9;var a6=a5.name=a8?(a5.extendedItemName+"_"+a5.guid):a5.extendedItemName;a9=g.getXmlTemplate("addCatalogItem.xml",a5);var a7=(a5.type=="page")?(be.contextRoot+"/portals/"+bd.selectedPortalName+"/masterpages/extend"):(be.contextRoot+"/portals/"+bd.selectedPortalName+"/catalog.xml");be.utils.ajax({url:a7,data:a9,type:"POST",encodeURI:false,success:function(){g.notify("the item was successfully added to the portal catalog","checkbox");ai(D,true,a6)}})})};var P=function(a5){jQuery(a5).parents(".bd-catalog-item").addClass("bd-catalog-default-icon")};var z=function(){var a5=function(a8){au.scrollTop(0);B(aI,a8);s(true)};var a7=j?n.portal:n.server;var a6=a7.map(function(a8){return{name:aU[a8],handler:function(){a5(a8)}}});a6.push({name:aQ,value:"all",handler:function(){a5(null)}});bc.component.dropdown({target:aK(".bd-catalog-item-types",V),label:aQ,uid:"04001",customHandlers:true,options:a6});bc.component.dropdown({target:aK(".bd-catalog-sort",V),label:be.utils.cookie(bd.portal.portalName+"_sortFieldLabel")||o,uid:"04002",customHandlers:true,options:[{name:aR,handler:function(){aO="property.title";be.utils.cookie(bd.portal.portalName+"_sortField",aO);be.utils.cookie(bd.portal.portalName+"_sortFieldLabel",aR);ai(D)}},{name:Q,handler:function(){aO="type";be.utils.cookie(bd.portal.portalName+"_sortField",aO);be.utils.cookie(bd.portal.portalName+"_sortFieldLabel",Q);ai(D)}},{name:o,handler:function(){aO="createdTimestamp";be.utils.cookie(bd.portal.portalName+"_sortField",aO);be.utils.cookie(bd.portal.portalName+"_sortFieldLabel",o);ai(D)}}]});if(ae==="asc"){aK(".bd-catalog-sort-dir > i").toggleClass("bi-pm-sort-asc bi-pm-sort-desc")}aK(".bd-catalog-sort-dir",V).off().on("click",function(){var a8=aK(this);aK("> i",a8).toggleClass("bi-pm-sort-asc bi-pm-sort-desc");ae=aK("> i",a8).hasClass("bi-pm-sort-desc")?"dsc":"asc";be.utils.cookie(bd.portal.portalName+"_sortDir",ae);ai(D)});bc.component.dropdown({target:aK(".bd-catalog-select",V),label:"SELECT",uid:"04003",customHandlers:true,staticLabel:true,options:[{name:aN,handler:function(){aF("all");bc.keepSelection=true;aD()}},{name:l,handler:function(){aF("none");bc.keepSelection=true;aD()}}]});aK(".bd-catalog-import",V).off().on("click",function(){ak();x()});aK(".bd-catalog-create",V).off().on("click",function(){y("","widget")});J=aK(".bd-catalog-tags-area",V);aK(".bd-catalog-tags-btn",V).off().on("click",af);V.on("click",".bd-catalog-tag-name",function(a8){var a9=aK(a8.target);if(a9.hasClass("bd-catalog-tag-filter-active")){a9.removeClass("bd-catalog-tag-filter-active");B(a0,null)}else{a9.addClass("bd-catalog-tag-filter-active").siblings().removeClass("bd-catalog-tag-filter-active");B(a0,a9.data("tag"))}s(true)});aK(".bd-catalog-search-box",V).off().on("keyup",function(){clearTimeout(an);var a8=aK(this);B(ag,a8.val());s(true)});aK(".bd-catalog-search-cancel",V).off().on("click",function(){aK(".bd-catalog-item-types ul.bc-selectbox",V)[0].dropdownOptions.find('a[data-value="all"]').trigger("click");B(aI,null);aK(".bd-catalog-search-box",V).val("");B(ag,null);s()});aK(".bd-catalog-export",V).off().on("click",function(a8){a8.stopPropagation();g.notify("Batch export: coming soon")});aK(".bd-catalog-remove",V).off().on("click",function(a8){a8.stopPropagation();var a9=N();U(a9)});aK(window).off("resize.tagsPanel").on("resize.tagsPanel",function(){if(V.hasClass("bd-catalog-tags-active")){ax()}})};var R=function(a8,a7,a5){V=aK(a8);am=[];aI={type:"type"};ag={type:"title"};a0={type:"tag"};j=a5;aE=aA+(j?"/"+bd.selectedPortalName:"");aa=new f.FormDataManager({url:aE,fileInputName:"package",allowMultipleFiles:false});if(j){aV=bd.contextRoot+"/portals/"+bd.selectedPortalName+"/catalog.xml";a3=bd.contextRoot+"/portals/"+bd.selectedPortalName+"/catalog/delete";i=bd.contextRoot+"/portals/"+bd.selectedPortalName+"/tags/catalog?ps=-1";var a6=aK(".bd-pageTitle",V);a6.text(a6.text()+" | "+bd.selectedPortalTitle)}ai(D);aw();z();au=aK(".bd-catalog-main",V);au.off().on("click",".bd-catalog-item",K).on("scroll",aG)};return{renderUI:R,urlID:"server-catalog",addServerCatalogItem:Z,imageErrorHandler:P}}(jQuery));b$.module("bd.widgets.ServerCatalog",function(){this.Maximized=bd.CatalogManager.renderUI});b$.module("bd.widgets.PortalCatalog",function(){this.Maximized=bd.CatalogManager.renderUI});return bd.CatalogManager});