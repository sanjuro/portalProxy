bd.CatalogManagement=(function(){var f;var j=function(u){var u=u||f.find(".bd-tabs > .bd-activeTab");var w=jQuery(u).attr("itemtype");var v=w.toUpperCase();return{itemType:v,activeTab:u}};var t=function(u){h("WIDGET","",function(v){e("WIDGET","",function(w){h("CONTAINER","",function(x){e("CONTAINER","",function(y){jQuery(u).html('Widgets<span class="bd-outcome-right">'+w.length+"/"+v.length+'</span><br>Layouts<span class="bd-outcome-right">'+y.length+"/"+x.length+"</span>")})})})})};var l=function(w,y,z){var B=[];for(var C=0;C<w.length;C++){var D=false;var A=w[C];if(bd.oPortalClient!=null&&bd.oPortalClient.params!=null&&A.properties.thumbnailUrl!=null){A.properties.thumbnailUrl.value=be.utils.replaceParams(A.properties.thumbnailUrl.value,bd.oPortalClient.params);A.properties.thumbnailUrl=A.properties.thumbnailUrl}for(var v=0;v<y.length;v++){var u=y[v];var E=A.name+"_"+z;var x=u.extendedItemName+"_"+u.contextItemName;if(E==x){D=true;break}}if(D){A.checked='checked="checked"';A.isChecked=true;B.push(A)}}return B};var r=function(w,y,z){for(var B=0;B<w.length;B++){var A=w[B];A.checked="";A.isChecked=false;if(bd.oPortalClient!=null&&bd.oPortalClient.params!=null&&A.properties.thumbnailUrl!=null){A.properties.thumbnailUrl.value=be.utils.replaceParams(A.properties.thumbnailUrl.value,bd.oPortalClient.params);A.properties.thumbnailUrl=A.properties.thumbnailUrl}for(var u=0;u<y.length;u++){var v=y[u];var C=A.name+"_"+z;var x=v.extendedItemName+"_"+v.contextItemName;if(C==x){A.checked='checked="checked"';A.isChecked=true;break}}}return w};var h=function(v,u,x){u=u||"";var w=bd.contextRoot+"/catalog.xml?s=lastModifiedTimestamp(dsc)&f=type(eq)"+v;w=w+"&ps="+bd.uiEditingOptions.catalog.itemsPerRequest;be.utils.ajax({url:w+u,cache:false,dataType:"xml",success:function(A){var B=bd.xmlToJson({xml:A});var y=v.toLowerCase();var z=B.catalog?B.catalog[y]:[];if(B.catalog==null){z=[]}else{if(z&&z.length==null){z=[z]}}if(x){x(z?z:[])}}})};var e=function(w,v,x){v=v||bd.selectedPortalName;var u=bd.contextRoot+"/portals/"+v+"/catalog.xml?s=lastModifiedTimestamp(dsc)&f=type(eq)"+w+"&ps="+bd.uiEditingOptions.catalog.itemsPerRequest;be.utils.ajax({url:u,cache:false,dataType:"xml",success:function(z){var B=bd.xmlToJson({xml:z});var y=w.toLowerCase();var A=B.catalog[y]||[];if(B.catalog==null||A==null){A=[]}else{if(A.length==null){A=[A]}}if(x){x(A)}}})};var c=function(x,w,y){var v=bd.contextRoot+"/tags/catalog?f=type(eq)"+x;var u=null;be.utils.ajax({url:v,dataType:"xml",success:function(z){u=bd.xmlToJson({xml:z}).tagArray;if(y){y(u)}}})};var d=function(F,D,E,G,u){var A="none",v="",x=null;f=jQuery(F);if(E==null){E="WIDGET";v="";templateData={portalTitle:bd.selectedPortalTitle,contextRoot:bd.contextRoot};var C=be.utils.processHTMLTemplate("catalogMgmntView",templateData);f.html(C);jQuery(".bd-tabLabels",F).undelegate(".bd-tabLabel","click").delegate(".bd-tabLabel","click",function(){var I=jQuery(this).attr("for");I=jQuery(I,f);var H=j(I).itemType;d(F,D,H,G,I)})}var z="#catalogFilterInput-"+E;if(jQuery(z,f).length>0){if(jQuery(z,f).data("tokenInputObject")===undefined){return}x=jQuery(z,f).tokenInput("get")}var y=j(u),u=y.activeTab,E=y.itemType;if(x!=null&&x.length!=null&&x.length>0){var w="";for(var B=0;x!=null&&x.length!=null&&B<x.length;B++){A=/^[^\r\f\n\t\"\'\\\/&%$#@!~]*$/.test(x[B].name);if(A==true){w+="&f=tag.name(like)"+x[B].name.substring(0,10);A="none"}else{A="block"}}v+=w}jQuery(".token-input-dropdown",f).remove();h(E,v,function(H){e(E,bd.selectedPortalName,function(I){c(E,bd.selectedPortalName,function(Q){var L=true;var U=function(V,W){jQuery(V).undelegate(".bd-catalogMnt-tag","click").delegate(".bd-catalogMnt-tag","click",function(aa){var X=jQuery(this).text()=="All Tags"?null:jQuery(this).text();A=/^[^\r\f\n\t\"\'\\\/&%$#@!~]*$/.test(X);if(A==true){var Z="#catalogFilterInput-"+W,Y=jQuery(Z,f);if(X!=null){L=false;Y.data("tokenInputObject").clear();L=true;Y.tokenInput("add",{id:X,name:X})}else{Y.data("tokenInputObject").clear()}}})};be.utils.domReady(z,function(Z){var X=function(){if(L){setTimeout(function(){jQuery(".token-input-dropdown",f).remove();n(jQuery(".displayPortalCatalogWidgetToggle")[0],E)},10)}};var aa=[];var V;for(var Y=0;x!=null&&x.length!=null&&Y<x.length;Y++){V=/^[^\r\f\n\t\"\'\\\/&%$#@!~]*$/.test(x[Y].name);if(V==true){aa.push({id:x[Y].name,name:x[Y].name})}}var W={minChars:2,tokenLimit:5,tokenValue:"name",prePopulate:aa,preventDuplicates:true,onAdd:X,hintText:"Search By Tag",onDelete:X,onReady:function(){bd.initTagsHightlight(Z)},classes:{tokenList:"token-input-list token-input-list-filter",dropdown:"token-input-dropdown token-input-dropdown-filter"}};Z.tokenInput(bd.contextRoot+"/json/tags.jsp?portalName="+bd.selectedPortalName+"&",W)});if(!G){H=r(H,I,bd.selectedPortalName)}else{H=l(H,I,bd.selectedPortalName)}for(var O=0,K=H.length;O<K;O++){var J=H[O];if(J.tagArray!=undefined&&J.tagArray.length>0){var T=[];for(var N=0,P=J.tagArray.length;N<P;N++){if(J.tagArray[N]!=null&&jQuery.type(J.tagArray[N])=="string"){T.push(J.tagArray[N])}}if(T.length>0){T.sort();J.tags=be.utils.truncateText(T.join(", "),60);J.hasTags=true}else{J.hasTags=false}}}var M=E.toLowerCase();var S={isLength:function(){return H.length},itemType:E,itemsName:M,error:A,serverCatalogItems:H,tagArray:Q,showOnlySelected:(G==true?"checked=checked":"")};var R=be.utils.processHTMLTemplate("catalog/itemsView",S);u.html(R);bc.component.dropdown({target:".bd-catalog-actions",label:"Actions",uid:"9875",staticLabel:true,options:[{name:"Add all "+M+"s to catalog",href:"#",classname:"bd-addAllWidgets",onclick:'return bd.CatalogManagement.registerItemsToCatalogAction("'+E+'")'},{name:"Remove all "+M+"s from catalog",href:"#",classname:"bd-removeAllWidgets",onclick:'return bd.CatalogManagement.removeItemsFromCatalogAction("'+E+'")'}]});U(u,E)})})})};var s=function(z,x,y,u){var w=function(F,D,G,E){var C=F.toLowerCase();var A="/catalog/"+C;var B=be.utils.xpathNodes(D,A);e(F,"",function(I){for(var H=0;H<B.length;H++){var J=be.utils.xpathSingleNode(B[H],"name/text()");if(y==J){b(B[H],C,x,I,u);break}}bc.component.notify({uid:"3456",icon:"checkbox",message:"The catalog for this portal has been updated."})})};var v=bd.contextRoot+"/catalog.xml?ps="+bd.uiEditingOptions.catalog.itemsPerRequest+"&s=lastModifiedTimestamp(dsc)&f=type(eq)"+z;be.utils.ajax({url:v,dataType:"xml",success:function(A){w(z,A)}})};var m=function(v){var u=v.toLowerCase();a(v,bd.selectedPortalName,true,false,function(){n(jQuery(".displayPortalCatalogWidgetToggle")[0],v);bc.component.notify({uid:"3457",icon:"checkbox",message:"The catalog for this portal has been updated."})})};var i=function(u,v){be.utils.ajax({url:bd.contextRoot+"/portals/"+bd.selectedPortalName+"/catalog/"+u,type:"DELETE",success:function(){bc.component.notify({uid:"3458",icon:"checkbox",message:"The catalog for this portal has been updated."});if(v){v()}},error:function(y,w,x){bc.component.notify({uid:"3426",icon:"error",message:"Error: The widget does not exist on the portal server"});if(v){v()}}})};var k=function(w){var v=function(C,A,D,B){var z=C.toLowerCase();var x=be.utils.xpathNodes(A,"/catalog/"+z+"/name/text()");for(var y=0;y<x.length;y++){if(y==x.length-1){i(x[y].nodeValue,function(){n(jQuery(".displayPortalCatalogWidgetToggle")[0],C);bc.component.notify({uid:"4465",icon:"checkbox",message:"The catalog for this portal has been updated."})})}else{i(x[y].nodeValue)}}};var u="/portals/"+bd.selectedPortalName+"/catalog.xml?ps="+bd.uiEditingOptions.catalog.itemsPerRequest+"&s=lastModifiedTimestamp(dsc)&f=type(eq)"+w;be.utils.ajax({url:bd.contextRoot+u,dataType:"xml",success:function(x){v(w,x)}})};var n=function(w,v){var u=j().activeTab;if(w.checked){d(f,null,v,true,u)}else{d(f,null,v,null,u)}};var q=function(A,w,B){var y=bd.selectedPortalName;var u=j().activeTab;var z=B;var x="#select"+B;var v=A==="WIDGET"?"widget":"layout";if(jQuery(x).is(":checked")){be.utils.confirm({title:"REMOVE "+v.toUpperCase()+" FROM THIS PORTAL",message:"Are you sure you want to remove this "+v+" from this portal?<br/>This will also remove all instances from the portal pages.<br/>This cannot be undone.",okBtnText:"Continue",cancelBtnText:"Cancel",yesCallback:function(){e(A,y,function(C){C.forEach(function(D){if(D.extendedItemName==z){i(D.name,function(){jQuery(w).addClass("bd-catalogMnt-widget-selected");jQuery(x).removeAttr("checked");n(jQuery(".displayPortalCatalogWidgetToggle",u)[0],A)})}})})},noCallback:function(){}})}else{be.utils.confirm({title:"INSTALL "+v.toUpperCase()+" TO THIS PORTAL",message:"Are you sure you want to make this "+v+" available to this portal?<br/>Note that if you want to publish, you have to install the item on those environments as well.<br/><br/>You can find the "+v+" in the "+v+" catalog (in Pages).",okBtnText:"Continue",cancelBtnText:"Cancel",yesCallback:function(){s(A,y,z,true);jQuery(w).addClass("bd-catalogMnt-widget-selected");jQuery(x).attr("checked","checked")},noCallback:function(){}})}};var p=function(u){if(u.checked){u.checked=false}else{u.checked=true}};var b=function(H,B,A,D,I,G){try{var E=be.utils.xpathSingleNode(H,"name/text()");var u=E;if(!g(u,D)){if(I){var F=""}else{var z=be.utils.xpathNodes(H,"properties")[0];var F=be.utils.xml2text(z)}var C=be.utils.xpathNodes(H,"tags")[0];var w=be.utils.xml2text(C);var y="<catalog><"+B+"><name>"+u+"</name><extendedItemName>["+E+"]</extendedItemName>"+F+((C==null)?"":w)+"</"+B+"></catalog>";var v=bd.contextRoot+"/portals/"+A+"/catalog.xml";be.utils.ajax({url:v,data:y,success:function(){if(G!=null){G(E)}},type:"POST",error:function(M,J,L){var K="The item already exists on the portal server.";if(M.status==404){K=E+" doesn't exist on the server catalog."}bc.component.notify({uid:"9901",icon:"error",message:K});if(G){G(null)}}})}else{if(G!=null){G(null)}}}catch(x){console.log(x)}};var g=function(x,w){var v=false;if(w!=null){for(var u=0;u<w.length;u++){if(x==w[u].name){v=true;break}}}return v};var o=function(v,w,u,x){a("PAGE",v,w,u,x)};var a=function(z,x,y,u,A){var w=function(F,D,H,G,E){var C=F.toLowerCase();var B=be.utils.xpathNodes(D,"/catalog/"+C);e(F,x,function(L){var J=0,I=[],K=function(M){if(M){I.push(M)}J++;if(J<B.length){b(B[J],C,x,L,u,K)}else{if(H){H(I)}}};b(B[J],C,x,L,u,K)})};var v=bd.contextRoot+"/catalog.xml?s=lastModifiedTimestamp(dsc)&f=type(eq)"+z+"&ps="+bd.uiEditingOptions.catalog.itemsPerRequest;be.utils.ajax({url:v,dataType:"xml",success:function(B){w(z,B,A)}})};return{renderUI:d,renderDashboard:t,registerItemToCatalog:s,registerPagesToCatalog:o,registerToCatalog:a,postItem:b,toggleSelection:n,toggleRegistration:q,checkRegistration:p,removeItemsFromCatalogAction:k,registerItemsToCatalogAction:m,removeItemFromPortalCatalog:i}}());