define(function(j,s,d){var n=bd.contextRoot+"/orchestrator/export/exportrequests",e=bd.contextRoot+"/orchestrator/export/files/",i=bd.contextRoot+"/export/package/",h={EXPORT_PORTAL_TXT_SUCCESS:"Portal export is ready!",EXPORT_PORTAL_TXT_HELP:"The exported zip file contains the portal Model (portal settings, permissions, pages, links, layouts and widgets) and portal Content (images and copy residing in the portal repository). It does not include resources.",EXPORT_PORTAL_TXT_TIPS:"Notes:<ul><li>To import this portal on another environment, place the package file in the standard import folder, or the auto import folder.</li><li>Note that the Application configuration and the WAR with JSP-templates and other resources are not included. Deploy those artifacts separately.</li><li>The maximum size is 10000 model items.</li><li>Note that this prepares for a full deployment, not an incremental deployment.</li></ul>",EXPORT_PORTAL_TXT_NOTIFICATION:"Exporting portal...",EXPORT_PORTAL_TXT_TITLE:"export portal",EXPORT_WIDGET_TXT_HELP:"You can export single widget as a package containing all related resources, such as stylesheets, images and javascripts.",EXPORT_WIDGET_TXT_TIPS:"",EXPORT_WIDGET_TXT_TITLE:"export widget",EXPORT_WIDGET_TXT_NOTIFICATION:"Exporting widget...",EXPORT_CONTAINER_TXT_HELP:"You can export single layout as a package containing all related resources, such as stylesheets, images and javascripts.",EXPORT_CONTAINER_TXT_HELP_MODEL:"You can export single layout as a package. Resources for this layout are not included in the package.",EXPORT_CONTAINER_TXT_TIPS:"",EXPORT_CONTAINER_TXT_TITLE:"export layout",EXPORT_CONTAINER_TXT_NOTIFICATION:"Exporting layout...",EXPORT_CONTENTTYPE_TXT_HELP:"You can export structured content type definition as a package containing all necessary resources",EXPORT_CONTENTTYPE_TXT_TIPS:"",EXPORT_CONTENTTYPE_TXT_TITLE:"export type definition",EXPORT_CONTENTTYPE_TXT_NOTIFICATION:"Exporting type definition...",EXPORT_PAGE_TXT_HELP:"You can export master page as a package containing all necessary resources",EXPORT_PAGE_TXT_TIPS:"",EXPORT_PAGE_TXT_TITLE:"export master page",EXPORT_PAGE_TXT_NOTIFICATION:"Exporting master page...",EXPORT_TEMPLATE_TXT_HELP:"You can export template as a package containing all necessary resources",EXPORT_TEMPLATE_TXT_TIPS:"",EXPORT_TEMPLATE_TXT_TITLE:"export template",EXPORT_TEMPLATE_TXT_NOTIFICATION:"Exporting template...",EXPORT_FEATURE_TXT_HELP:"You can export feature as a package containing all necessary resources",EXPORT_FEATURE_TXT_TIPS:"",EXPORT_FEATURE_TXT_TITLE:"export feature",EXPORT_FEATURE_TXT_NOTIFICATION:"Exporting feature...",EXPORT_ITEM_TXT_FAILURE:"Export failed!",EXPORT_BTN_OK:"OK",EXPORT_BTN_OR:"OR",EXPORT_BTN_CLOSE:"Close",EXPORT_BTN_DOWNLOAD:"Download",EXPORT_BTN_EXPORT:"Export",EXPORT_BTN_CANCEL:"Cancel",IMPORT_PORTAL_TXT_TITLE:"import portal",IMPORT_WIDGET_TXT_TITLE:"import widget",IMPORT_TXT_TIPS:"Click to select file or drop it in area below",IMPORT_TXT_TIPS_IE:"Select file",IMPORT_TXT_DROP:"Drop file here",IMPORT_BTN_IMPORT:"Import",IMPORT_BTN_CANCEL:"Cancel",IMPORT_TXT_NOTIFICATION:"Import in progress",IMPORT_TXT_NO_FILE:"You must select file before import",IMPORT_TXT_SUCCESS_TITLE:"Import succeeded",IMPORT_PORTAL_TXT_SUCCESS_TEXT:"Portal imported successfully",IMPORT_WIDGET_TXT_SUCCESS_TEXT:"Widget imported successfully",IMPORT_TXT_FAIL_TITLE:"Import failed",IMPORT_TXT_FAIL_TEXT:"Something went wrong"},c={"*":"Unknown server error",INTERNAL_SERVER_ERROR:"Unknown server error",ERROR_EXPORTING_CONTENT:"Error exporting content",ERROR_ACCESSING_ARCHIVE:"Error accessing archive",ERROR_CREATING_PORTAL_SERVER_BUNDLE:"Error creating portal server bundle",ERROR_EXPORTING_FROM_PORTAL_SERVER:"Error exporting from portal server",ERROR_CREATING_EXPORT_ARCHIVE:"Error creating export archive",FILE_NOT_FOUND:"File not found",EXPORT_TOO_BIG:"Too many items to export",ERROR_CREATING_TEMPLATE_EXPORT:"Error exporting templates"},k=bd.contextRoot+"/orchestrator/import/upload",f={"*":"Unknown server error",INTERNAL_SERVER_ERROR:"Unknown server error",ERROR_INVALID_ARCHIVE:"Invalid portal archive",ERROR_IMPORTING_CONTENT:"Error importing content",ERROR_READING_PORTAL_SERVER_BUNDLE:"Error creating portal server bundle",ERROR_IMPORTING_TO_PORTAL_SERVER:"Error importing to portal server",ERROR_UPLOADING:"Error uploading",ERROR_MISSING_RESOURCES:"Some portal resources missing (showing only first 10)",PORTALSERVER_CONNECTION_EXCEPTION:"Portal server seems to be down"},b=null,l=function(u){var v,w="hiddenDownloader";v=document.getElementById(w);if(v===null){v=document.createElement("iframe");v.id=w;v.style.display="none";document.body.appendChild(v)}v.src=u},a=function(y,z){var x=jQuery(y),w=x.find("exportResponse"),v=w.length?w:x,u={archiveLocation:be.utils.getNodeText("> archiveLocation",v),archiveSize:be.utils.getNodeText("> archiveSize",v),logfileLocation:be.utils.getNodeText("> logFileLocation",v),identifier:be.utils.getNodeText("> identifier",v)},A=be.utils.processHTMLTemplate("export/exportResponse",u);bc.component.dialog({title:h["EXPORT_"+z.toUpperCase()+"_TXT_SUCCESS"],message:A,buttons:[{title:h.EXPORT_BTN_DOWNLOAD,type:"white",callback:function(){l(e+u.identifier)}},{title:h.EXPORT_BTN_OR,textOnly:true},{title:h.EXPORT_BTN_CLOSE,type:"text",callback:function(){}}]});bd.observer.notifyObserver(bd.notifications.session.TIMEOUT_OVERRIDE,{on:false})},g=function(u,w){var v=be.utils.getNodeText("message",jQuery(u.responseXML));bc.component.dialog({title:h.EXPORT_ITEM_TXT_FAILURE,message:c[v]||v,buttons:[{title:h.EXPORT_BTN_OK,type:"white",style:{width:"100px"},callback:function(){}}]});bd.observer.notifyObserver(bd.notifications.session.TIMEOUT_OVERRIDE,{on:false})},t=function(w,z,v,y,x,B){var u={itemName:w,itemType:z,includeContent:v,includeGroups:y,includeResources:x,contextItemName:B?B:"[BBHOST]"},A=be.utils.processXMLTemplate(z+"Export",u);bd.observer.notifyObserver(bd.notifications.session.TIMEOUT_OVERRIDE,{on:true});be.utils.ajax({url:n,data:A,success:function(C){a(C,z)},error:function(C){g(C,z)},contentType:"text/xml",type:"POST",dataType:"xml",skipTimeout:true})},o=function(x,w){var v=w?w+"/":"",u=i+v+x;l(u)},r=function(G,C,D,x){var B=C&&C.toLowerCase()==="portal",F=B?"portalForm":"genericForm",A=be.utils.loadTemplate("export/"+F,"html",false),u=jQuery(A),w=u.find(".bd-export-help"),z=u.find(".bd-export-tips"),v=null,y=null,E=null;bc.component.hint({target:w,message:h["EXPORT_"+C.toUpperCase()+"_TXT_HELP"+(D?"_MODEL":"")]});bc.component.hint({target:z,message:h["EXPORT_"+C.toUpperCase()+"_TXT_TIPS"]});A=u.get(0).outerHTML;u=bc.component.modalform({width:"450px",title:h["EXPORT_"+C.toUpperCase()+"_TXT_TITLE"]+": "+G,uid:"1230",cls:"bd-export",content:A,ok:h.EXPORT_BTN_EXPORT,cancel:h.EXPORT_BTN_CANCEL,okCallback:function(H){bc.component.notify({icon:"loading",message:h["EXPORT_"+C.toUpperCase()+"_TXT_NOTIFICATION"]});if(B){t(G,C,!!H.find(".bd-export-toggle-content").find('input[type="checkbox"]').attr("checked"),!!H.find(".bd-export-toggle-groups").find('input[type="checkbox"]').attr("checked"),!!H.find(".bd-export-toggle-resources").find('input[type="checkbox"]').attr("checked"),x)}else{o(G,x)}},cancelCallback:function(){}});v=u.find(".bd-export-toggle-content");y=u.find(".bd-export-toggle-groups");E=u.find(".bd-export-toggle-resources");bc.component.toggleSwitch({target:v,checked:true});bc.component.toggleSwitch({target:y,checked:true});bc.component.toggleSwitch({target:E,checked:true})},m=function(z,x,y){if(z.length<=x){return z}y=y||"/.../";var u=z.split("/");var v=u[u.length-1];var w=x-v.length-y.length;return z.substr(0,w)+y+v},p=function(v){var u={missingResources:[]};v.find("importValidatorResponse > resources > resource").each(function(x,y){var z=jQuery(y);var A=z.attr("path");var w=m(A);u.missingResources.push({path:A,pathShort:m(A,50,"/.../")})});return be.utils.processHTMLTemplate("export/missingResources",u)},q=function(E,H){E=E||"portal";var F={dropZoneText:jQuery.browser.msie?"":h.IMPORT_TXT_DROP};var B=be.utils.processHTMLTemplate("portals/importForm",F),w=jQuery(B),y=w.find(".bd-export-help"),C=w.find(".filename"),x=null,A=null,I={},u=0,G=null,z=null,D=null,v=null;bc.component.hint({target:C,message:jQuery.browser.msie?h.IMPORT_TXT_TIPS_IE:h.IMPORT_TXT_TIPS});B=w.get(0).outerHTML;w=bc.component.modalform({width:"450px",title:h["IMPORT_"+E.toUpperCase()+"_TXT_TITLE"],cls:"bd-export",content:B,ok:h.IMPORT_BTN_IMPORT,cancel:h.IMPORT_BTN_CANCEL,okCallback:function(J){if(I.fileName&&I.data){v=bc.component.notify({icon:"loading",message:h.IMPORT_TXT_NOTIFICATION,delay:-1});I.data.submit()}else{bc.component.notify({icon:"error",message:h.IMPORT_TXT_NO_FILE});return false}},cancelCallback:function(){}});if(!jQuery.browser.msie){jQuery(".bd-import-uploadForm",w).bind("click",function(){jQuery(".bd-import-uploadForm-uploadField",w).trigger("click")})}jQuery(".bd-import-uploadForm",w).fileupload({type:"POST",fileInput:jQuery(".bd-import-uploadForm-uploadField"),url:k,dropZone:jQuery(".bd-import-uploadForm",w),forceIframeTransport:true,singleFileUploads:true,add:function(K,J){I.data=J;I.fileName=J.files[0].name;w.find(".bd-import-uploadForm span").text(I.fileName);w.find(".bd-import-uploadForm").addClass("file-selected")},done:function(L,K){if(K.result.find("importErrorMessage").length>0){D="error";G=h.IMPORT_TXT_FAIL_TITLE;if(K.result.find("importErrorMessage > importValidatorResponse").length>0){var J=K.result.find("importErrorMessage > message");z=(J.length>0?J.text():f.ERROR_MISSING_RESOURCES)+p(K.result)}}else{if(K.result.find("errorMessage").length>0){D="error";G=h.IMPORT_TXT_FAIL_TITLE;z=K.result.find("errorMessage > message").text()}else{D="ok";G=h.IMPORT_TXT_SUCCESS_TITLE;z=h["IMPORT_"+E.toUpperCase()+"_TXT_SUCCESS_TEXT"]}}},fail:function(L,J){var K=be.utils.getNodeText("message",jQuery(J.jqXHR.responseXML));D="error";G=h.IMPORT_TXT_FAIL_TITLE;z=f[K]||f["*"]},always:function(K,J){v.hide();bc.component.dialog({title:G,message:z,status:D,buttons:[{title:h.EXPORT_BTN_OK,type:"white",style:{width:"100px"},callback:function(){if(typeof H==="function"){H()}}}]})}})};d.exports={exportItem:r,importItem:q}});