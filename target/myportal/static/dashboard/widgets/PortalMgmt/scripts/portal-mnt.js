define(["jquery","dashboard/widgets/PortalMgmt/scripts/portalmanagement"],function(d,a){var e=32;var f=function(g){if(g.hasOwnProperty("thumbnailUrl")){return g.thumbnailUrl.value.toString().replace("$(contextRoot)",bd.contextRoot)}return null};var c=function(l){var m=[],g=(l.portals.portal instanceof Array)?l.portals:{portal:[l.portals.portal]},h=0;for(var k=0;k<g.portal.length;k++){if(g.portal[k]["securityProfile"]=="CONSUMER"&&g.portal[k]["name"]=="dashboard"){continue}var n=g.portal[k];var j=n.properties;if(j.title===null||j.title.value===""){j.title={value:"No title"}}if(j.DefaultDevice===null||j.DefaultDevice.value===""){j.DefaultDevice={value:"NONE"}}m.push({securityProfile:n.securityProfile,title:j.title.value,portalName:n.name,deviceTarget:j.hasOwnProperty("TargetedDevice")?j.TargetedDevice.value:"",defaultDevice:j.DefaultDevice.value,thumbnailUrl:f(j),truncatedTitle:(j.title.value!==null)?be.utils.truncateText(j.title.value,e):j.title["itemName"],thumbnailLabel:"insert portal image"});h++}return m};var b=function(h){var g=be.utils.getErrorText(h);bc.component.notify({uid:"292822",icon:"error",message:g});if(typeof callback==="function"){callback.call(this,arguments)}};bd.createPortalList=function(){var g=function(){var t=3;var C="portals/portalListView";var y='<span class="bd-listPageDots">.</span>';var G=d(".bd-portalList");var s=d(G).find(".bd-listDataholder")[0];var E=d(G).find(".bd-listPageDotsContainer")[0];var r=d('<div class="bd-portalSearchOverlay"></div>').appendTo(G);var m="",x,D;var F=0;var u=false;var h=false;var K=0;var I;var q=function(L,O){var N=bd.xmlToJson({xml:L}),P,M;if(N===null){return}if(N.portals.portal==undefined){window.location.reload(true)}I=c(N);P=I;M=I.length;bd.portals=P.concat([]);if(!bd.portals.length){d(".bd-listNextPageButton",G).remove()}K=Math.ceil(M/t);var R=be.utils.processHTMLTemplate(C,{portals:P});d(s).html(R);var S=d(E);if(P.length>3){B(E,true);for(i=0;i<K;i++){var Q=d(y);Q.attr("page",i);Q.css("cursor","pointer");if(F==i){Q.addClass("bd-active")}Q.appendTo(S)}}else{S.html("")}j();if(O){l()}};var l=function(){G.delegate(".bd-listNextPageButton","click",function(){if(F<K-1){F++;j()}});G.delegate(".bd-listPreviousPageButton","click",function(){if(F>0){F--;j()}});G.delegate(".bd-listPageDots","click",function(){F=Number(d(this).attr("page"));j()});G.delegate(".bd-portalListItem","click",function(L){bd.selectedPortalName=d(this).attr("portalname");bd.selectedPortalTitle=d(this).attr("portaltitle");bd.selectedPortalOptimizedFor=d(this).attr("defaultDevice");bd.selectedPortalTargetDevice=d(this).attr("devicetarget");bd.loadPage("launcher",L)});G.on("mousewheel DOMMouseScroll",function(L){L.preventDefault();L.stopPropagation();H(L.originalEvent.wheelDelta||-L.originalEvent.detail)});d("body").on("keypress",function(M){if(be.dialogContainersStack.length===0&&d(".bc-modal-cover").length===0){if(!M.ctrlKey&&!M.metaKey&&M.which>46){clearTimeout(x);clearTimeout(D);var L=String.fromCharCode(M.which);m+=L;r.text(m);r.css({opacity:0.8,marginLeft:-r.width()/2,zIndex:999,visibility:"visible"});x=setTimeout(function(){var Q=new RegExp(m,"i");for(var P=0,N=bd.portals.length;P<N;P++){if(Q.test(bd.portals[P].title)){var O=Math.floor(P/t);z(O);j();d('.bd-portalListItem[portalname="'+bd.portals[P].portalName+'"]',G).addClass("bd-portalSelected").siblings().removeClass("bd-portalSelected");break}}},100);D=setTimeout(function(){r.css({opacity:0});D=setTimeout(function(){r.css({zIndex:-1,visibility:"hidden"})},100);m=""},500)}else{if(M.which===13){d(".bd-portalListItem.bd-portalSelected",G).trigger("click")}}}});d("body").on("click",function(){if(be.dialogContainersStack.length===0&&d(".bc-modal-cover").length===0){d(".bd-portalListItem.bd-portalSelected",G).removeClass("bd-portalSelected")}})};var A=false;var n=285,w=855,o=10;var j=function(){A=true;d(s).animate({left:(-F*w-o)+"px"},{duration:500,complete:function(){A=false}});var L=d(E).find(".bd-listPageDots");d.each(L,function(M,N){if(M===F){d(N).addClass("bd-active")}else{d(N).removeClass("bd-active")}});v()};var H=function(L){if(!A){A=true;if(L<0){d(".bd-listNextPageButton",G).trigger("click")}else{if(L>0){d(".bd-listPreviousPageButton",G).trigger("click")}}setTimeout(function(){A=false},500)}};var B=function(O,M,L,P,N,Q){if(O){if(M){d(O).removeClass("bd-hideElement");if(L){d(L).delegate(P,N,Q)}}else{d(O).addClass("bd-hideElement");if(L){d(L).undelegate(P,N,Q)}}}};var v=function(){var N=".bd-listNextPageButton";var M=".bd-listPreviousPageButton";var O=d(G).find(N)[0];var L=d(G).find(M)[0];if(u||h){B(O,u);B(L,h);u=false;h=false;return}if(K==1){B(O,false);B(L,false)}else{if(F===0){B(O,true);B(L,false)}else{if(F==K-1){B(O,false);B(L,true)}else{B(O,true);B(L,true)}}}};var J=function(){var L="lastModifiedTimestamp(dsc)";var M="1000";return bd.contextRoot+"/portals.xml?s="+L+"&ps="+M};var z=function(L){F=L};var p=function(M){M=!(M||false);d(E).html("");var L=J();be.utils.ajax({url:L,data:null,cache:false,success:function(N){q(N,M)},dataType:"xml",accept:"application/xml;charset=UTF-8"})};var k=function(){d(s).html("");p(true)};return{loadPortals:p,refreshPortals:k,setPage:z}}();bd.portalList=g;g.loadPortals()};bd.refreshPortalList=function(g){if(bd.portalList){bd.portalList.setPage(0);bd.portalList.refreshPortals()}};bd.cancelCreatePortal=function(){try{d("#portalDetailsArea").hide();d(".bd-portalDetailsViewport").show();return be.closeCurrentDialog()}catch(g){console.log(g)}};bd.syncOptimizedForView=function(g){if(d("#OptimizedForView .bd-selected").attr("optimizedFor")=="tablet"){d("#OptimizedForView .bd-selected .bd-optimizedFor-label").text("Tablet")}else{if(d("#OptimizedForView .bd-selected").attr("optimizedFor")=="mobile"){d("#OptimizedForView .bd-selected .bd-optimizedFor-label").text("Mobile")}}d("#OptimizedForView .bd-selected").removeClass("bd-selected");d("#OptimizedForView .bd-optimizedFor-"+g).addClass("bd-selected");d("#OptimizedFor").val(g)};bd.createNewPortal=function(g){if(bd.designMode!="null"){return false}var k={contextRoot:bd.contextRoot,urlRoot:be.utils.getURLRoot(),mobile:bd.uiEditingOptions.portalDevices.mobile,tablet:bd.uiEditingOptions.portalDevices.tablet};var m=d(be.utils.processHTMLTemplate("portals/createPortal",k));var q=d("#OptimizedForView",m);var p=bc.component.dropdown({type:"device-select",device:"tablet",deviceName:"Tablet",options:bd.uiEditingOptions.portalDevices.tablet});var r=bc.component.dropdown({type:"device-select",device:"mobile",deviceName:"Mobile",options:bd.uiEditingOptions.portalDevices.mobile});var j=r[0].dropdownOptions;var n=p[0].dropdownOptions;d("#OptimizedForView",m).append(p);d("#OptimizedForView",m).append(r);be.openDialog({event:g,htmlContent:m,standAlone:true,className:"bd-createPortalDialog",small:true,headerCloseIcon:false,containerMargins:{mLeft:330,mTop:200}});d("a",n).click(function(){h(this,p)});d("a",j).click(function(){h(this,r)});var h=function(u,t){var s=d(".bc-device-name",u).text();if(s.toLowerCase()=="all tablet devices"){s="Tablet"}else{if(s.toLowerCase()=="all mobile devices"){s="Mobile"}}d(".bd-optimizedFor-label",t).text(s)};d("#portalTitle").focus();q.delegate(".bd-optimizedFor","click",function(s){bd.syncOptimizedForView(d(this).attr("optimizedfor"))});bd.syncOptimizedForView(q.children(".bd-optimizedFor-mixed").attr("optimizedfor"));var o=false;var l=function(s){try{var t=s.portalName.value;if(o){return}o=true;bd.savePortalFromForm(s,"POST",function(v){o=false})}catch(u){console.log(u)}return false};be.utils.addCustomMethodToValidator(["validTitle"]);d("#newPortalForm").validate({rules:{portalTitle:{validTitle:true}},messages:{portalTitle:{validTitle:"Portal title can not contain any special characters"}},submitHandler:function(s){setTimeout(function(){l(s)},100)}});bd.initEditable(d("#newPortalForm"));bd.enableSwitch(d("#addAllWidgets"));return false};bd.savePortalFromForm=function(n,p,g){var z=be.utils.formatAllowedTitle(n.portalTitle.value);var B=n.portalName.value;var j=n.thumbnailUrl.value;var y=null;var v=false;if(n.addAllWidgets&&n.addAllWidgets.checked){v=true}var o=d("#OptimizedFor").val();var k=null;if(n.oldPortalName){k=n.oldPortalName.value}var A=d(".bd-publishchain-dd").find(".bc-multiselect"),r=[],m="",q=A.data("portalPubChains"),h=false;if(A.length){d(A[0].dropdownOptions).find("a.bc-dropdown-item").each(function(l,C){if(d(C).find('input[type="checkbox"]:checked').length){r.push(d(C).attr("data-value"))}});if(r.length===q.length){var t,s,x,w=(r.slice(0)).sort();for(t=0,s=q.length;t<s;t++){x=q[t];if(q[t]!==w[t]){h=true;break}}}else{h=true}m=r.join(";")}var u=function(){bd.savePortalWithInputData(z,B,k,v,o,p,y,g,m,j)};if(!h){u()}else{be.utils.confirm({title:"UPDATE PORTAL",message:"You are about to change the publication end point. When you change the publication end point, the status of all published items will be set to 'not published'.",okBtnText:"Save",yesCallback:u})}};bd.savePortalWithInputData=function(x,y,m,v,q,r,w,j,o,l){var u="";var p=d("#OptimizedForView");switch(q){case p.children(".bd-optimizedFor-tablet").attr("optimizedfor"):u=bd.uiEditingOptions.defaultPageTemplates.tablet;break;case p.children(".bd-optimizedFor-mobile").attr("optimizedfor"):u=bd.uiEditingOptions.defaultPageTemplates.mobile;break;case p.children(".bd-optimizedFor-mixed").attr("optimizedfor"):u=bd.uiEditingOptions.defaultPageTemplates.smart;break;case p.children(".bd-optimizedFor-web").attr("optimizedfor"):u=bd.uiEditingOptions.defaultPageTemplates.web;break}var n=q;if(q=="tablet"||q=="mobile"){n=p.find("*[optimizedFor="+q+"]").children(".bd-optimizedFor-label").text();n=n=="Tablet usage"?"Tablet":n;n=n=="Mobile usage"?"Mobile":n}var k={name:y,title:x,OptimizedFor:q,targetDevice:n,thumbnailUrl:l,hasTags:false,tags:[],hasPublishchain:typeof o=="string"||o instanceof String,publishChains:o};var t="createPortal";var s="";var g=bd.contextRoot+"/portals.xml";if(r=="PUT"){g=bd.contextRoot+"/portals/"+m+".xml";t="updatePortal";s=be.utils.processXMLTemplate(t,k)}else{if(r=="POST"){g=bd.contextRoot+"/portals/"+y+"/createPortal?title="+x+"&targetDevice="+n+"&optimizedFor="+q+"&addAllWidgets="+v}}var h=function(A){var z=d("#portalLauncher-tabs");d("#bd-saveButton",z).attr("disabled","true");d(".bd-cancelButton",z).attr("disabled","true");d(".bd-popupForm-closeButton",z).attr("onclick","");if(r=="POST"){bc.component.notify({uid:"0012",icon:"loading",message:"Creating "+x})}setTimeout(function(){if(r=="POST"){bd.cancelCreatePortal();if(typeof j==="function"){j.call(this,arguments)}bc.component.notify({uid:"2928",icon:"checkbox",message:x+" was created successfully."});a.refreshPortalDetails()}else{bd.selectedPortalName=y;bd.selectedPortalTitle=x;bd.selectedPortalOptimizedFor=q;bd.selectedPortalTargetDevice=n;a.refreshPortalDetails();bc.component.notify({uid:"2928",icon:"checkbox",message:x+" was updated successfully."})}},400)};be.utils.ajax({url:g,data:s,success:h,error:b,type:r});return false};bd.updatePortal=function(g){bd.savePortalFromForm(g,"PUT")};bd.updatePortalName=function(g){var h=be.utils.removeNonAlphaNumericChars(g.value);g.form.portalName.value=h;g.form.portalPath.value=bd.contextRoot+"/"+h+"/pages/index";return false};bd.addPage=function(g,h,k){var j=be.utils.processHTMLTemplateByUrl(be.contextRoot+"/static/backbase.com.2012.nexus/widgets/PageMgmtMVC/xml/pages/createPage.html",g);be.utils.ajax({url:bd.contextRoot+"/portals/"+h+"/pages.xml",data:j,success:k,type:"POST"});return false};bd.addLink=function(h,k,g){var j=be.utils.processHTMLTemplateByUrl(be.contextRoot+"/static/backbase.com.2012.nexus/widgets/PageMgmtMVC/xml/links/createLink.html",h);be.utils.ajax({url:bd.contextRoot+"/portals/"+h.portalName+"/links.xml",data:j,success:function(l){if(k){k(l)}},error:g,type:"POST"});return false};bd.deleteLink=function(j,h,k,g){be.utils.ajax({url:bd.contextRoot+"/portals/"+h+"/links/"+j+".xml",success:k,error:g,type:"DELETE"});return false};bd.createPortal=function(l,k,g,m,n,h){var j=bd.contextRoot+"/portals/"+l+"/createPortal?title="+k+"&targetDevice="+g+"&optimizedFor="+g+"&addAllWidgets="+m;be.utils.ajax({url:j,success:function(o){n(o)},error:function(o){h(o)},type:"POST"});return false};bd.deletePortal=function(h,j,g){be.utils.ajax({url:bd.contextRoot+"/portals/"+h+".xml",success:j,error:g,type:"DELETE"});return false};bd.getPortalsModel=function(){var j="lastModifiedTimestamp(dsc)",l="1000",h=bd.contextRoot+"/portals.xml?s="+j+"&ps="+l,g=new d.Deferred(),m=g.promise();var k=function(o){var n=bd.xmlToJson({xml:o});if(n===null){return}bd.portalsModel=c(n);g.resolve(bd.portalsModel)};be.utils.ajax({url:h,data:null,cache:false,dataType:"xml",accept:"application/xml;charset=UTF-8"}).done(k);return m};return{}});