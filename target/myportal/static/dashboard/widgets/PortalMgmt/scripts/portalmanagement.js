define(["dashboard/widgets/PortalMgmt/scripts/portal-export","angular","zenith/utils","zenith/http/portals"],function(b,h,i,c){var e=this||{},d=window.bd||{},k;var g=function(m,n){m=m||jQuery("#listOfPortals").val();var l=function(){be.utils.ajax({url:d.contextRoot+"/portals/"+m+"/deletePortal",success:function(s,r,q,p){if(s.documentElement!=null&&s.documentElement.nodeName=="parsererror"){console.log("API Error: "+s.documentElement.firstChild.nodeValue)}else{if(s.responseText!=null&&s.responseText.contains("Error")){console.log(s.responseText)}}if(d.closeLauncher){d.closeLauncher();d.selectedPortalName="dashboard";bc.component.notify({uid:"1998",icon:"checkbox",message:m+" was deleted successfully."});if(n!=null){n()}}else{var o=location.search?location.search:"";location.href=d.contextRoot+"/portals/dashboard"+o}},type:"DELETE"});return false};be.utils.confirm({title:"REMOVE PORTAL",message:"This will remove the portal and all its pages and cannot be undone. Are you sure you want to continue?",yesCallback:l});return false};if(d.test){d.test.deletePortal=g}var f=function(){return c.portalDetails(d.selectedPortalName,null,true).then(function(l){e.portalDataJson=l;j();return l})};var j=function(){var m=e.portalDataJson;var l=m.properties;var o=l.TargetedDevice.value;d.typeOfTags=[];if(l.TypeOfTags&&l.TypeOfTags.value!=null){try{d.typeOfTags=l.TypeOfTags.value.split(",")}catch(n){console.log(n)}}m.isDashboard=(m.name=="dashboard");d.mobileDrawer=false;if(!m.isDashboard){d.mobileDrawer=o}if(m.tag!=null&&m.tag!=false){m.tag=(typeof m.tag=="object"?false:m.tag.replace(/,/g,", "))}if(l.DefaultLandingPage.value!=null&&l.DefaultLandingPage.value.indexOf("http://")==0){m.onClick=m.linkText="window.open('"+l.DefaultLandingPage.value+"')"}else{m.onClick="window.open('"+be.utils.getURLRoot()+d.contextRoot+"/portals/"+m.name+"')";m.linkText=d.contextRoot+"/portals/"+(m.name.length>14?m.name.substring(0,14)+"...":m.name)}if(l.publishChains){if(l.publishChains.value===null){l.publishChains.value=""}l.publishChains.text=l.publishChains.value.replace(/;/g,", ")}be.utils.processHTMLTemplate("portals/portalDetails",m,function(p){e.$portalDetailsViewport.html(p)})};var a=function(u,x){d.selectedPortalName=x.name;d.selectedPortalTitle=x.getProperty("title");d.selectedPortalOptimizedFor=x.getProperty("DefaultDevice");d.selectedPortalTargetDevice=x.getProperty("TargetedDevice");k=u;var A=jQuery(".bd-portalDetailsViewport",u);e.$portalDetailsViewport=A;var z=jQuery(".bd-specialPagesViewport",u);e.$portalSpecialPagesViewport=z;f();var q=["DefaultLandingPage","LoginPage","LogoutPage","ErrorPage","AccessDeniedPage","AuthenticationFailurePage"];if(d.designMode==="null"||d.designMode===false){jQuery(".bd-tabLabels",u).delegate(".bd-tab2","click",function(){var B={portalName:d.selectedPortalName,itemName:d.selectedPortalName,itemType:"portal",context:d.contextRoot+"/portals/"+d.selectedPortalName,domParent:".portalPermissions",hideCloseButtons:true,closeCallback:function(){d.closeLauncher()}};d.Permission.loadPermissionsAndGroups(B)});jQuery(".bd-tabLabels",u).delegate(".bd-tab3","click",function(){m("portals/portalSpecialPages",true)});var r=function(){m("portals/editPortalSpecialPages",true,v)};var v=function(){be.utils.addCustomMethodToValidator(["specialPageUrlSpecialChar","defaultLandingPageUrlSpecialChar"]);var D={};for(var B=0,C;C=q[B];B++){if(C==="DefaultLandingPage"){D[C]={defaultLandingPageUrlSpecialChar:true}}else{D[C]={specialPageUrlSpecialChar:true}}}jQuery("#bd-portalSpecialPages-updateForm").validate({rules:D,submitHandler:y});be.closeCurrentDialogCallback=function(){jQuery(u).find(".bd-specialPageSettingsCancel").trigger("click")}};jQuery(u).delegate(".bd-specialPagesEditButton","click",r);var o;var m=function(B,D,E){var C={};if(o&&!D){C=o;t(B)}else{be.utils.ajax({url:d.contextRoot+"/portals/"+d.selectedPortalName+".xml?pc=false",dataType:"xml",cache:false,type:"GET",success:function(G){var F=d.xmlToJson({xml:G});o=F;t(B,E)}})}};var t=function(D,H){var E=o;for(var C in E.portal.properties){var F=E.portal.properties[C];if(F.value){if(F.value.type){F.value=null}}}var G=be.utils.processHTMLTemplate(D,E.portal);z.html(G);if(D=="portals/editPortalSpecialPages"){var B=E.portal.properties}jQuery(u).delegate(".bd-specialPagesCloseButton","click",function(){d.closeLauncher()});if(H){H()}};jQuery(u).delegate(".bd-specialPageSettingsCancel","click",function(){m("portals/portalSpecialPages")});var y=function(){var D={name:d.selectedPortalName,otherSpecialPage:[]};for(var C=0,B=q.length;C<B;C++){var H=q[C];var F=jQuery(".bd-special-"+H,z);var E=jQuery.trim(F.val());if(E!=F.attr("oldvalue")){D.otherSpecialPage.push({specialPageName:H,specialPageValue:E})}}var G=be.utils.processXMLTemplate("updateSpecialPages",D);be.utils.ajax({url:d.contextRoot+"/portals/"+d.selectedPortalName+".xml",data:G,success:function(I){m("portals/portalSpecialPages",true);bc.component.notify({uid:"6283",icon:"checkbox",message:"Special pages updated successfully."})},contentType:"text/xml",type:"PUT"});return false}}var n=function(){var O=e.portalDataJson,H=d.selectedPortalName,Q=d.selectedPortalTitle,G=d.selectedPortalOptimizedFor||"mixed",E="",N=d.selectedPortalTargetDevice;if(jQuery.type(O.tagArray)=="array"){E=O.tagArray.join(",")}var F={contextRoot:d.contextRoot,portalName:H,portalTitle:Q,portalTitleFormatted:be.utils.formatAllowedName(Q),tags:"",urlRoot:be.utils.getURLRoot(),thumbnailUrl:O.thumbnailUrl,thumbnailSrc:O.thumbnailSrc};var M,L;if(G=="mobile"){M=true}if(G=="tablet"){L=true}var J=be.utils.processHTMLTemplate("portals/editPortal",F);var K=bc.component.dropdown({type:"device-select",device:"tablet",deviceName:function(){if(L){return N}else{return"Tablet"}},options:d.uiEditingOptions.portalDevices.tablet});var P=bc.component.dropdown({type:"device-select",device:"mobile",deviceName:function(){if(M){return N}else{return"Mobile"}},options:d.uiEditingOptions.portalDevices.mobile});var D=P[0].dropdownOptions;var I=K[0].dropdownOptions;i.inject(J,function(R){A.html(R)},k);$("#OptimizedForView",A).append(K);$("#OptimizedForView",A).append(P);$("a",I).click(function(){C(this,K)});$("a",D).click(function(){C(this,P)});var C=function(T,S){var R=$(".bc-device-name",T).text();if(R.toLowerCase()=="all tablet devices"){R="Tablet"}else{if(R.toLowerCase()=="all mobile devices"){R="Mobile"}}$(".bd-optimizedFor-label",S).text(R);d.syncOptimizedForView(S.attr("optimizedfor"))};$("#OptimizedForView",A).delegate(".bd-optimizedFor","click",function(R){d.syncOptimizedForView(jQuery(this).attr("optimizedfor"))});d.syncOptimizedForView(G);s().then(function(R,S){l(A,R,S)},function(R){console.log(R)});var B=function(R){try{d.updatePortal(R)}catch(S){console.log(S)}return false};be.utils.addCustomMethodToValidator(["validTitle"]);jQuery("#newPortalForm").validate({rules:{portalTitle:{validTitle:true}},messages:{portalTitle:{validTitle:"Portal title can not contain any special characters"}},submitHandler:B});d.initEditable(jQuery("#newPortalForm"));return false};var w=function(F,E,B,D,C){b.exportItem(F,"portal")};var s=function(){var B=jQuery.Deferred();be.utils.ajax({url:d.contextRoot+"/orchestrator/configuration.xml",success:function(H){var D=[],F=e.portalDataJson.properties,I=F.publishChains&&F.publishChains.value?F.publishChains.value.split(";"):[],E,C,J,G={};for(E=0,C=I.length;E<C;E++){J=I[E];G[J]=true}jQuery(H).find("publishChainName").each(function(K,M){var L=jQuery(M).text();D.push({name:L,value:L,checked:!!G[L]})});B.resolve(D,I)},error:function(C){B.reject(C)},contentType:"text/xml",type:"GET"});return B.promise()};var l=function(H,C,G){var B=H.find(".bd-publishchain-dd").empty();var E=bc.component.dropdown({type:"multi-select",staticLabel:true,uid:"723641230",target:B,label:"Loading",options:C}),D=E[0].dropdownOptions,F=function(){var J=D.find('input[type="checkbox"]:checked'),I="";if(!C||!C.length){I="No publish chain available";E.addClass("bd-groups-empty")}else{if(J.length<1){I="Select a publish chain"}else{if(J.length===1){I=J.length+" chain"}else{I=J.length+" chains"}}E.removeClass("bd-groups-empty")}E.children(".bc-label").text(I)};jQuery("a, .bc-custom-checkbox",D).click(F);E.data("portalPubChains",G.sort());F()};A.on("click",".bd-editButton",n);A.delegate(".bd-removeButton","click",function(){g(d.selectedPortalName)});bc.component.setTooltip(".bd-exportButton",{context:u});A.delegate(".bd-exportButton","click",function(){w(d.selectedPortalName)});var p=function(){bc.component.modalform({width:"310px",title:"Duplicate portal",uid:"duplicate_portal_modal",cls:"bd-duplicate",content:'<fieldset><label>New name</label><input type="text" class="bd-new-portal-name required" maxlength="45" /></fieldset>',ok:"Duplicate",cancel:"Cancel",okCallback:function(B){var C=$(".bd-new-portal-name",B).val();if(encodeURIComponent(C).length<100){be.utils.ajax({url:d.contextRoot+"/portals/"+d.selectedPortalName+"/duplicate.xml?targetName="+C,cache:false,type:"POST",success:function(D){bc.component.notify({uid:"duplicate_portal_success",icon:"checkbox",message:"Portal duplicated"});d.refreshPortalList()}})}else{bc.component.notify({uid:"encodedPortalNameMaxLenghtExceeded",icon:"error",message:"Encoded portal name has exceeded maximum length of 100 characters."});$(".bd-new-portal-name",B).removeClass("valid error").addClass("error");return false}}})};A.delegate(".bd-duplicateButton","click",p);A.delegate(".bd-cancelEditPortal","click",j)};return{Start:a,refreshPortalDetails:f}});