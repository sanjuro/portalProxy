bd.Versions={$cancelButton:jQuery('<button class="bd-button bd-cancel-version-preview bd-roundcorner-3" data-isAppended="false">&laquo; Cancel</button>'),$previewMetaData:jQuery('<div class="bd-preview-meta-data"></div>'),$previewWarningWrapper:jQuery('<div class="bd-preview-warning-wrapper"></div>'),$versionPreviewWrapper:jQuery('<div class="bd-iframe-preview-wrapper"></div>'),$versionPreviewFrame:jQuery('<iframe class="bd-version-preview-frame" frameborder="no" style="height: 100%; width:100%; display: inline; z-index: 0;" src="">'),$versionPreviewOverlay:jQuery('<div class="bd-version-overlay" style="display:none;"><div class="bd-overlay-icon"></div><div class="bd-overlay-text"></div></div>'),$domParent:null,$versionListOverLay:jQuery('<div class="bd-version-list-cover bc-icn-spinner"></div>'),getVersionData:function(b,c){var a=bd.contextRoot+"/versions/"+b+".xml";be.utils.ajax({url:a,cache:false,dataType:"xml",error:function(d){if(d.responseText.indexOf("Version history not found for linkuuid")){jQuery(".bd-listDataholder",bd.Versions.$domParent).append('<li class="bc-1"><h3 class="bc-i bc-no-margin-top">Versions</h3></li><li class="bc-1"><span class="bc-i">No versions found for this page.</span></li>');if(bd.Versions.inContextNav.getStatus()){bd.Versions.inContextNav.status=false;bd.Versions.$previewMetaData.empty().append('<span class="bd-versions-number">0</span> <span class="bd-version-title">Versions</span><span class="bd-version-url">No versions found for this page.</span>')}bd.Versions.$versionListOverLay.hide()}},success:function(d){var f=g()?(new XMLSerializer()).serializeToString(d):d;var e=bd.xmlToJson({xml:f});c(b,e);function g(){return !(window.ActiveXObject)&&"ActiveXObject" in window}}})},get:function(b,a){be.utils.ajax({url:b,cache:false,type:"GET",dataType:"xml",error:function(d){var c="An unknown error occurred.";if(d.responseText&&jQuery(d.responseText).find(".bd-errorDescription").text()){c=jQuery(d.responseText).find(".bd-errorDescription").text()}bc.component.notify({icon:"error",message:c})},success:function(c){if(a){a(c)}}})},createListContent:function(f,e){var b=parseInt(e.versions.totalSize,10),a,c,d=function(){var g=be.utils.processHTMLTemplate("../html/versions/editVersionsList",e);$(".bd-listDataholder",bd.Versions.$domParent).append(g)};if(b===1){e.versions.version=[e.versions.version]}if(b>0){e.versions.latestVersionCreatedDate=e.versions.version[0].createdDate}for(c=0;c<b;c++){a=e.versions.version[c];if(a.createdDate){a.createdDate=bd.date.formatDateTime(a.createdDate)}if(c>0){a.allowRestore=true}a.versionNumber=b-c}bd.Versions.tryInsertDraftVersion(e.versions,d)},buildVersionList:function(b,a){bd.Versions.createListContent(b,a);bd.Versions.$domParent.undelegate(".bd-versions-restore","click").delegate(".bd-versions-restore","click",function(e){e.preventDefault();var f=jQuery(this).data("uuid"),c=jQuery(this).data("version"),d=jQuery(this).data("versionnum");be.utils.confirm({title:"Restore Page",message:"Are you sure you want to restore this page to version "+d+"? <br/><br/>Don't forget to publish again",yesCallback:function(){bd.Versions.restoreVersion(f,c,function(){bd.Versions.$iframeContainer[0].src=bd.Versions.$iframeContainer[0].src;bc.component.dialog({title:"Restore complete",message:"The version was successfully restored.",buttons:[{title:"OK",type:"white",style:{width:"100px"},callback:function(){be.commonContentUtils.cleanPTCCache();bd.PageMgmtTree.publishing.requestPackage();bd.Versions.$cancelButton.click()}}]})})},noCallback:null,cancelBtnText:"Cancel",okBtnText:"Restore"})})},tryInsertDraftVersion:function(a,e){var b,c,d=function(f){var g={createdBy:bd.loggedInUserId,createdDate:bd.date.formatDateTime(f),publishId:"",linkUuid:bd.PageMgmtTree.selectedLink.uuid,draft:true,versionNumber:"",status:"Draft"};a.version.unshift(g);c.allowRestore=true};if(a.totalSize>0){c=a.version[0];if(bd.PageMgmtTree.selectedLink.referencedItem){bd.pm.controller.getPageByUuid(bd.PageMgmtTree.selectedLink.referencedItem.uuid,function(f){if(Date.parse(f.lastModifiedTimestamp)>Date.parse(a.latestVersionCreatedDate)){d(f.lastModifiedTimestamp)}e()})}else{if(Date.parse(bd.PageMgmtTree.selectedLink.lastModifiedTimestamp)>Date.parse(a.latestVersionCreatedDate)){d(bd.PageMgmtTree.selectedLink.lastModifiedTimestamp)}e()}}else{e()}},restoreVersion:function(c,a,d){var b=bc.component.notify({icon:"loading",message:"Restore in progress",delay:-1});console.log("To send to server -- UUID = "+c+", Version = "+a);be.utils.ajax({url:bd.contextRoot+"/versions/"+c+"/restore/"+a,cache:false,type:"post",dataType:"xml",error:function(f){var e="An unknown error occurred.";if(f.responseText&&jQuery(f.responseText).find(".bd-errorDescription").text()){e=jQuery(f.responseText).find(".bd-errorDescription").text()}bc.component.notify({icon:"error",message:e,uid:1534});b.hide()},success:function(e){b.hide();if(d){d()}}})},previewVersion:function(b){var a=bd.contextRoot+"/portals/"+bd.selectedPortalName+"/links/"+b.linkUUID+"/version/"+b.version;bd.Versions.get(a,function(g){var f=bd.xmlToJson({xml:g}).link,h=f.properties.itemType.value;be.utils.mergeJsonObj(f,b);f.friendlyUrl=f.properties.itemType.value==="externalLink"?f.finalUrl:window.location.protocol+"//"+window.location.hostname+":"+window.location.port+bd.contextRoot+"/"+f.finalUrl;bd.Versions.$previewMetaData.html(jQuery(be.utils.processHTMLTemplate("../html/versions/versionMetadata",f)));var c=function(){var i=bd.contextRoot+"/portals/"+bd.selectedPortalName+"/pages/"+b.linkUUID+"/version/"+b.version+"/restorable";bd.Versions.get(i,function(l){var j={missingItems:[]};var k=jQuery(l);k.find("restorewarnings > restorewarning").each(function(m,o){var n=jQuery(o);j.missingItems.push(n.find("itemName").text())});if(j.missingItems.length>0){j.missingItems=j.missingItems.join(", ");jQuery(".bd-pageMgmtTree").addClass("bd-version-warning");bd.Versions.$previewWarningWrapper.html(be.utils.processHTMLTemplate("../html/versions/versionWarnings",j)).show();bd.Versions.$previewWarningWrapper.off().on("click",".bd-version-reload-preview",function(){c()})}else{jQuery(".bd-pageMgmtTree").removeClass("bd-version-warning");bd.Versions.$previewWarningWrapper.hide()}})};c();if(bd.Versions.inContextNav.getStatus()){bd.Versions.$versionListOverLay.hide();bd.Versions.inContextNav.status=false;return}if(h==="page"||h==="alias"||h==="targeting"){bd.Versions.$versionPreviewOverlay.hide();var e=bd.contextRoot+"/portals/"+bd.selectedPortalName+"/pages/"+b.linkUUID+"/version/"+b.version+"/preview";bd.Versions.$versionPreviewFrame.attr("src",e).show();bd.observer.notifyObserver(bd.notifications.versions.PREVIEW)}else{bd.Versions.$versionPreviewFrame.hide();var d={divider:"DIVIDER (NO PREVIEW)",menuHeader:"HEADER (NO PREVIEW)",externalLink:'GO TO <a class="bg-iframeOverlayGo">EXTERNAL LINK</a>',redirect:'SHOW <a class="bg-iframeOverlayGo">REDIRECT TARGET</a>'};bd.Versions.$versionPreviewOverlay.children(".bd-overlay-icon").removeClass().addClass("bd-overlay-icon bd-overlay-icon-"+h);bd.Versions.$versionPreviewOverlay.children(".bd-overlay-text").html("<p>"+(d[h]||"")+"</p>");bd.Versions.$versionPreviewOverlay.show().undelegate(".bg-iframeOverlayGo","click").delegate(".bg-iframeOverlayGo","click",function(i){var j=f.properties.itemType.value;if(j==="redirect"){bd.Versions.$versionPreviewOverlay.hide();bd.Versions.$versionPreviewFrame.attr("src",f.friendlyUrl).show()}else{window.open(f.friendlyUrl)}})}})},setPreviewMode:function(h,n){bd.Versions.previewMode=true;var f=jQuery(".bd-pageContainer"),j=jQuery(".bd-iframeContainer"),a=jQuery("#bd-iframeOverlay"),s=jQuery(".bd-pageSettingsContainer"),p=jQuery(".bp-resizeable-two-column--left"),c=jQuery(".bp-resizeable-two-column--right"),e=jQuery(".bp-resizeable-two-column--row1"),d=jQuery(".bp-resizeable-two-column--row2"),o=jQuery(".bd-close-settings-panel-arrow"),i=jQuery('div[class*="bd-tabLabel bd-tab"]').not('div[class*="bd-activeTab"]'),r=jQuery(".bd-tab4.bd-activeTab"),l=$(".bc-form-body").not(".bd-scrollbar"),b=$(".bd-scrollbar").not(".bc-form-body");bd.Versions.$iframeContainer=j;p.css({"margin-left":"-"+p.width()+"px"});c.addClass("resizable-right-version-preview");e.css({height:"calc(100% - 950px)"});d.css({height:"100%"});i.addClass("version-preview-component-hidden");o.addClass("version-preview-component-hidden");l.css({padding:"0px 5px"});b.css({position:"relative",width:"100%"});var m=bd.Versions.$cancelButton,t=m.attr("data-isAppended"),g=jQuery(".bd-cancel-version-preview"),k;if(g){k=g.attr("data-isAppended");if(k==="true"){m=g;t=k}}if(t==="false"){m.css({"float":"right",display:"block",marginTop:-13});r.after(m)}bd.Versions.$cancelButton.unbind("click").bind("click",function(u){u.preventDefault();q(c.width());bd.Versions.$versionPreviewWrapper.hide();bd.Versions.$previewMetaData.hide();bd.observer.notifyObserver(bd.notifications.versions.HIDE,bd.PageMgmtTree.selectedLink);j.removeClass("bd-version-previewing").show();jQuery(".editPageTabs_Versions").removeClass("bd-versions-editing");jQuery(".bd-pageSettingsContainer").removeClass("bd-versions-editing");if(bd.Versions.overlayHidden){delete bd.Versions.overlayHidden;a.show()}jQuery(".bd-portalPagesListViewport").jstree("select_node","#"+bd.Versions.inContextNav.linkUUID,true)});if(bd.Versions.$versionPreviewWrapper[0].parentNode!==jQuery(".bd-tdIframeContainer")[0]){jQuery(".bd-tdIframeContainer").prepend(bd.Versions.$versionPreviewWrapper).prepend(bd.Versions.$previewWarningWrapper).prepend(bd.Versions.$previewMetaData.show());bd.Versions.$versionPreviewWrapper.append(bd.Versions.$versionPreviewFrame).append(bd.Versions.$versionPreviewOverlay).show();bd.Versions.$versionPreviewFrame.load(function(){if(this.contentWindow){bd.Versions.enableInContextNav(this.contentWindow)}})}bd.Versions.$versionPreviewWrapper.show();bd.Versions.$previewMetaData.show();be.commonContentUtils.cleanPTCCache(function(){bd.Versions.previewVersion(h)});j.hide().addClass("bd-version-previewing");if(a.is(":visible")){bd.Versions.overlayHidden=true;a.hide()}jQuery(".bd-pageVersionsList ul").removeClass("bd-version-selected");jQuery(n).parents("ul.bc-hover-list").addClass("bd-version-selected");jQuery(".editPageTabs_Versions").addClass("bd-versions-editing");jQuery(".bd-pageSettingsContainer").addClass("bd-versions-editing");function q(u){p.css({"margin-left":"0"});c.removeClass("resizable-right-version-preview");e.css({height:"33px"});d.css({height:"calc(100% - 74px)"});i.removeClass("version-preview-component-hidden");o.removeClass("version-preview-component-hidden");l.css({padding:"5px 10px"});b.css({position:"absolute",width:"488px"});m.css({display:"none"})}},loadVersions:function(c){bd.Versions.$domParent=jQuery(c.domParent);var b=c.linkUUID,a=c.templateData;if(!jQuery(".bd-pageContainer").children(".bd-version-list-cover").length){jQuery(".bd-pageContainer").append(bd.Versions.$versionListOverLay)}bd.Versions.$domParent.html(be.utils.processHTMLTemplate("../html/versions/editPageVersions",a)).undelegate(".bd-versions-preview, .bd-pageVersionsList","click").delegate(".bd-pageVersionsList","click",function(e){e.preventDefault();var d=jQuery(e.target);if(d.is(".bd-versions-button, .bd-versions-not-restorable, .bd-scrollbar")){return}else{d.closest("ul").find(".bd-versions-preview").click()}}).delegate(".bd-versions-preview","click",function(g){g.preventDefault();var e=this,f=jQuery(e),d={linkUUID:f.data("uuid"),version:f.data("version"),versionNum:f.data("versionnum"),datetime:f.data("datetime"),user:f.data("user")};bd.Versions.setPreviewMode(d,e);g.stopPropagation()}).off("version.createdListContent").on("version.createdListContent",function(){if(bd.Versions.inContextNav.getStatus()){bd.Versions.$domParent.find(".bd-versions-preview:first").click()}});bd.Versions.getVersionData(b,bd.Versions.buildVersionList)},inContextNav:{status:false,linkUUID:"",getStatus:function(){return bd.Versions.inContextNav.status&&jQuery(".bd-iframeContainer").hasClass("bd-version-previewing")}},enableInContextNav:function(e){var b=e.location.href,c=new RegExp("/portals/"+bd.selectedPortalName+"/pages/(.*)/version/(.*)/preview","gi"),d=e.b$&&e.b$.portal&&e.b$.portal.linkUUID?e.b$.portal.linkUUID:"";if(b.match(c)){var a=b.slice(b.indexOf("/pages/")+7);a=a.slice(0,a.indexOf("/"));bd.Versions.inContextNav.linkUUID=a}else{if(d){bd.Versions.inContextNav.status=false;bd.Versions.$cancelButton.click();bd.observer.notifyObserver(bd.pm.observer.refreshTab,{uuid:d,eventType:"click",hideSettingsPanel:true})}}}};