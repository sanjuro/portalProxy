(function(e){var c={method:"GET",queryParam:"q",searchDelay:300,minChars:1,propertyToSearch:"name",jsonContainer:null,contentType:"json",prePopulate:null,processPrePopulate:false,hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",deleteText:"&times;",animateDropdown:true,theme:null,zindex:999,resultsLimit:null,resultsFormatter:function(g){return"<li>"+g[this.propertyToSearch]+"</li>"},tokenFormatter:function(g){return"<li><p>"+g[this.propertyToSearch]+"</p></li>"},tokenLimit:null,tokenDelimiter:",",preventDuplicates:false,tokenValue:"id",onResult:null,onAdd:null,onDelete:null,onReady:null,idPrefix:"token-input-",disabled:false,selectSuggestion:true,enableComma:true,clearOnBlur:true};var f={tokenList:"token-input-list",token:"token-input-token",tokenReadOnly:"token-input-token-readonly",tokenDelete:"token-input-delete-token",selectedToken:"token-input-selected-token",highlightedToken:"token-input-highlighted-token",dropdown:"token-input-dropdown",dropdownItem:"token-input-dropdown-item",dropdownItem2:"token-input-dropdown-item2",selectedDropdownItem:"token-input-selected-dropdown-item",inputToken:"token-input-input-token",focused:"token-input-focused",disabled:"token-input-disabled"};var d={BEFORE:0,AFTER:1,END:2};var a={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,NUMPAD_ENTER:108,COMMA:188};var b={init:function(g,h){var i=e.extend({},c,h||{});return this.each(function(){e(this).data("tokenInputObject",new e.TokenList(this,g,i))})},clear:function(){this.data("tokenInputObject").clear();return this},add:function(g){this.data("tokenInputObject").add(g);return this},remove:function(g){this.data("tokenInputObject").remove(g);return this},get:function(){return this.data("tokenInputObject").getTokens()},toggleDisabled:function(g){this.data("tokenInputObject").toggleDisabled(g);return this}};e.fn.tokenInput=function(g){if(b[g]){return b[g].apply(this,Array.prototype.slice.call(arguments,1))}else{return b.init.apply(this,arguments)}};e.TokenList=function(i,s,T){if(e.type(s)==="string"||e.type(s)==="function"){T.url=s;var m=x();if(T.crossDomain===undefined&&typeof m==="string"){if(m.indexOf("://")===-1){T.crossDomain=false}else{T.crossDomain=(location.href.split(/\/+/g)[1]!==m.split(/\/+/g)[1])}}}else{if(typeof(s)==="object"){T.local_data=s}}if(T.classes){T.classes=e.extend({},f,T.classes)}else{if(T.theme){T.classes={};e.each(f,function(Z,aa){T.classes[Z]=aa+"-"+T.theme})}else{T.classes=f}}var F=[];var v=0;var r=new e.TokenList.Cache();var R;var N;var z=e('<input type="text"  autocomplete="off">').css({outline:"none"}).attr("id",T.idPrefix+i.id).focus(function(){if(T.disabled){return false}else{p.addClass(T.classes.focused);if(T.tokenLimit===null||T.tokenLimit!==v){setTimeout(function(){l()},50)}}}).blur(function(){G();if(T.clearOnBlur){e(this).val("")}p.removeClass(T.classes.focused)}).bind("keyup keydown blur update",g).keydown(function(aa){var ac;var Z;switch(aa.keyCode){case a.LEFT:case a.RIGHT:case a.UP:case a.DOWN:if(!e(this).val()){ac=n.prev();Z=n.next();if((ac.length&&ac.get(0)===D)||(Z.length&&Z.get(0)===D)){if(aa.keyCode===a.LEFT||aa.keyCode===a.UP){K(e(D),d.BEFORE)}else{K(e(D),d.AFTER)}}else{if((aa.keyCode===a.LEFT||aa.keyCode===a.UP)&&ac.length){U(e(ac.get(0)))}else{if((aa.keyCode===a.RIGHT||aa.keyCode===a.DOWN)&&Z.length){U(e(Z.get(0)))}}}}else{var ab=null;if(!T.selectSuggestion){if(aa.keyCode===a.LEFT||aa.keyCode===a.RIGHT){return}if(aa.keyCode===a.DOWN){if(!P){ab=V.find("li:first")}else{ab=e(P).next()}}else{if(aa.keyCode===a.UP){if(!P){ab=V.find("li:last")}else{ab=e(P).prev()}}}if(ab&&ab.length){X(ab)}else{h(e(P))}}else{if(aa.keyCode===a.DOWN||aa.keyCode===a.RIGHT){ab=e(P).next()}else{ab=e(P).prev()}if(ab.length){X(ab)}}}return false;break;case a.BACKSPACE:ac=n.prev();if(!e(this).val().length){if(D){k(e(D),false);E.change()}else{if(ac.length){U(e(ac.get(0)))}}return false}else{if(e(this).val().length===1){G()}else{setTimeout(function(){C()},5)}}break;case a.ENTER:case a.NUMPAD_ENTER:case a.COMMA:if(!T.enableComma&&aa.keyCode===a.COMMA){return}if(P){M(e(P).data("tokeninput"));E.change()}else{G()}return false;break;case a.ESCAPE:G();return true;default:if(String.fromCharCode(aa.which)){setTimeout(function(){C()},5)}break}});var E=e(i).hide().val("").focus(function(){Y(z)}).blur(function(){z.blur()});var D=null;var H=0;var P=null;var p=e("<ul />").addClass(T.classes.tokenList).click(function(aa){var Z=e(aa.target).closest("li");if(Z&&Z.get(0)&&e.data(Z.get(0),"tokeninput")){W(Z)}else{if(D){K(e(D),d.END)}Y(z)}}).mouseover(function(aa){var Z=e(aa.target).closest("li");if(Z&&D!==this){Z.addClass(T.classes.highlightedToken)}}).mouseout(function(aa){var Z=e(aa.target).closest("li");if(Z&&D!==this){Z.removeClass(T.classes.highlightedToken)}}).insertBefore(E);var n=e("<li />").addClass(T.classes.inputToken).appendTo(p).append(z);var V=e("<div>").addClass(T.classes.dropdown).appendTo("body").hide();var L=e("<tester/>").insertAfter(z).css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:z.css("fontSize"),fontFamily:z.css("fontFamily"),fontWeight:z.css("fontWeight"),letterSpacing:z.css("letterSpacing"),whiteSpace:"nowrap"});E.val("");var y=T.prePopulate||E.data("pre");if(T.processPrePopulate&&e.isFunction(T.onResult)){y=T.onResult.call(E,y)}if(y&&y.length){e.each(y,function(Z,aa){j(aa);I()})}if(T.disabled){B(true)}if(e.isFunction(T.onReady)){T.onReady.call()}this.clear=function(){p.children("li").each(function(){if(e(this).children("input").length===0){k(e(this),false)}})};this.add=function(Z){M(Z)};this.remove=function(Z){p.children("li").each(function(){if(e(this).children("input").length===0){var ac=e(this).data("tokeninput");var aa=true;for(var ab in Z){if(Z[ab]!==ac[ab]){aa=false;break}}if(aa){k(e(this),false)}}})};this.getTokens=function(){return F};this.toggleDisabled=function(Z){B(Z)};function B(Z){if(typeof Z==="boolean"){T.disabled=Z}else{T.disabled=!T.disabled}z.prop("disabled",T.disabled);p.toggleClass(T.classes.disabled,T.disabled);if(D){K(e(D),d.END)}E.prop("disabled",T.disabled)}function I(){if(T.tokenLimit!==null&&v>=T.tokenLimit){z.hide();G();return}}function g(){if(N===(N=z.val())){return}var Z=N.replace(/&/g,"&amp;").replace(/\s/g," ").replace(/</g,"&lt;").replace(/>/g,"&gt;");L.html(Z);z.width(L.width()+30)}function S(Z){return((Z>=48&&Z<=90)||(Z>=96&&Z<=111)||(Z>=186&&Z<=192)||(Z>=219&&Z<=222))}function j(ab){var aa=T.tokenFormatter(ab);if(!aa){return}var ad=e(aa);var Z=ab.readonly===true?true:false;if(Z){ad.addClass(T.classes.tokenReadOnly)}ad.addClass(T.classes.token).insertBefore(n);if(!Z){e("<span>"+T.deleteText+"</span>").addClass(T.classes.tokenDelete).appendTo(ad).click(function(){if(!T.disabled){k(e(this).parent(),false);E.change();return false}})}var ac=ab;e.data(ad.get(0),"tokeninput",ab);F=F.slice(0,H).concat([ac]).concat(F.slice(H));H++;w(F,E);v+=1;if(T.tokenLimit!==null&&v>=T.tokenLimit){z.hide();G()}return ad}function M(Z){var ac=T.onAdd;if(v>0&&T.preventDuplicates){var ab=null;var aa=T.propertyToSearch?T.propertyToSearch:"id";p.children().each(function(){var ae=e(this);var ad=e.data(ae.get(0),"tokeninput");if(ad&&ad[aa]===Z[aa]){ab=ae;return false}});if(ab){U(ab);n.insertAfter(ab);Y(z);return}}if(T.tokenLimit==null||v<T.tokenLimit){j(Z);I()}z.val("");G();if(e.isFunction(ac)){ac.call(E,Z)}}function U(Z){if(!T.disabled){Z.addClass(T.classes.selectedToken);D=Z.get(0);z.val("");G()}}function K(aa,Z){aa.removeClass(T.classes.selectedToken);D=null;if(Z===d.BEFORE){n.insertBefore(aa);H--}else{if(Z===d.AFTER){n.insertAfter(aa);H++}else{n.appendTo(p);H=v}}Y(z)}function W(aa){var Z=D;if(D){K(e(D),d.END)}if(Z===aa.get(0)){K(aa,d.END)}else{U(aa)}}function k(ab,aa){var ac=e.data(ab.get(0),"tokeninput");var ad=T.onDelete;if(aa!=false){aa=true}var Z=ab.prevAll().length;if(Z>H){Z--}ab.remove();D=null;if(aa){Y(z)}F=F.slice(0,Z).concat(F.slice(Z+1));if(Z<H){H--}w(F,E);v-=1;if(T.tokenLimit!==null){z.show().val("");if(aa){Y(z)}}if(e.isFunction(ad)){ad.call(E,ac)}}function w(ab,Z){var aa=e.map(ab,function(ac){if(typeof T.tokenValue=="function"){return T.tokenValue.call(this,ac)}return ac[T.tokenValue]});Z.val(aa.join(T.tokenDelimiter))}function G(){V.hide().empty();P=null}function q(){V.css({position:"absolute",top:e(p).offset().top+e(p).outerHeight(),left:e(p).offset().left,width:e(p).width()+3,"z-index":T.zindex}).show()}function o(){if(T.searchingText){V.html("<p>"+T.searchingText+"</p>");q()}}function l(){if(T.hintText){V.html("<p>"+T.hintText+"</p>");q()}}var J=new RegExp("[.\\\\+*?\\[\\^\\]$(){}=!<>|:\\-]","g");function Q(Z){return Z.replace(J,"\\$&")}function u(aa,Z){return aa.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+Q(Z)+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>")}function A(aa,ab,Z){return aa.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+Q(ab)+")(?![^<>]*>)(?![^&;]+;)","g"),u(ab,Z))}function O(ab,Z){if(Z&&Z.length){V.empty();var aa=e("<ul>").appendTo(V).mouseover(function(ac){X(e(ac.target).closest("li"))}).mousedown(function(ac){M(e(ac.target).closest("li").data("tokeninput"));E.change();return false}).hide();if(T.resultsLimit&&Z.length>T.resultsLimit){Z=Z.slice(0,T.resultsLimit)}e.each(Z,function(ac,ad){var ae=T.resultsFormatter(ad);ae=A(ae,ad[T.propertyToSearch],ab);ae=e(ae).appendTo(aa);if(ac%2){ae.addClass(T.classes.dropdownItem)}else{ae.addClass(T.classes.dropdownItem2)}if(ac===0&&T.selectSuggestion){X(ae)}e.data(ae.get(0),"tokeninput",ad)});q();if(T.animateDropdown){aa.slideDown("fast")}else{aa.show()}}else{if(T.noResultsText){V.html("<p>"+T.noResultsText+"</p>");q()}else{G()}}}function X(Z){if(Z){if(P){h(e(P))}Z.addClass(T.classes.selectedDropdownItem);P=Z.get(0)}}function h(Z){Z.removeClass(T.classes.selectedDropdownItem);P=null}function C(){var Z=z.val();if(Z&&Z.length){if(D){K(e(D),d.AFTER)}if(Z.length>=T.minChars){o();clearTimeout(R);R=setTimeout(function(){t(Z)},T.searchDelay)}else{G()}}}function t(ag){var aa=ag+x();var ah=r.get(aa);if(ah){O(ag,ah)}else{var Z=x();if(Z){var af={};af.data={};if(Z.indexOf("?")>-1){var ad=Z.split("?");af.url=ad[0];var ab=ad[1].split("&");e.each(ab,function(ai,ak){var aj=ak.split("=");af.data[aj[0]]=aj[1]})}else{af.url=Z}af.data[T.queryParam]=ag;af.type=T.method;af.dataType=T.contentType;if(T.crossDomain){af.dataType="jsonp"}af.success=function(ai){if(e.isFunction(T.onResult)){ai=T.onResult.call(E,ai)}if(T.cache){r.add(aa,T.jsonContainer?ai[T.jsonContainer]:ai)}if(z.val()===ag){O(ag,T.jsonContainer?ai[T.jsonContainer]:ai)}};if(typeof T.overwriteRetrieveData==="function"){var ac={searchBy:z.val()};T.overwriteRetrieveData(ac,z.val(),O)}else{e.ajax(af)}}else{if(T.local_data){var ae=e.grep(T.local_data,function(ai){return ai[T.propertyToSearch].toLowerCase().indexOf(ag.toLowerCase())>-1});if(e.isFunction(T.onResult)){ae=T.onResult.call(E,ae)}if(T.cache){r.add(aa,ae)}O(ag,ae)}}}}function x(){var Z=T.url;if(typeof T.url=="function"){Z=T.url.call(T)}return Z}function Y(Z){setTimeout(function(){Z.focus()},50)}};e.TokenList.Cache=function(h){var j=e.extend({max_size:500},h);var k={};var i=0;var g=function(){k={};i=0};this.add=function(m,l){if(i>j.max_size){g()}if(!k[m]){i+=1}k[m]=l};this.get=function(l){return k[l]}}}(jQuery));